\hypertarget{AdmUnit_8py_source}{}\subsection{Adm\+Unit.\+py}
\label{AdmUnit_8py_source}\index{E\+L\+O/\+Adm/\+Adm\+Unit.\+py@{E\+L\+O/\+Adm/\+Adm\+Unit.\+py}}

\begin{DoxyCode}
\hypertarget{AdmUnit_8py_source_l00001}{}\hyperlink{namespaceAdm_1_1AdmUnit}{00001} \textcolor{comment}{#coding: utf-8}
00002 
00003 \textcolor{comment}{## TODO:}
00004 \textcolor{comment}{#   Passar para inglês os termos internos ao sistema que estão em português. }
00005 \textcolor{comment}{#       (e.g. 214, 234, 240)}
00006 \textcolor{comment}{#   Ajeitar os nomes das forms. (Adm/forms)}
00007 \textcolor{comment}{#   Atentar ao padrão de 80 caracteres/linha.}
00008 \textcolor{comment}{#   233: verificar validade do request.POST, tal qual if anterior.}
00009 
00010 \textcolor{comment}{## @file AdmUnit.py}
00011 \textcolor{comment}{#   Este arquivo é responsável pelo armazenamento de todas as camadas }
00012 \textcolor{comment}{#   correspondentes ao módulo de administrador. }
00013 \textcolor{comment}{#   Os métodos aqui são criados e chamados pela Factory (MainUnit.py)}
00014 \textcolor{comment}{#   quando necessários. }
00015 \textcolor{comment}{#   São responsáveis por cadastrar, deletar e editar alunos e professores }
00016 \textcolor{comment}{#   no banco de dados, criar cursos e ver um log sobre os últimos eventos no}
00017 \textcolor{comment}{#   sistema.}
00018 
00019 \textcolor{keyword}{from} abc \textcolor{keyword}{import} *
00020 
00021 \textcolor{keyword}{import} \hyperlink{namespaceELO_1_1locale_1_1index}{ELO.locale.index} \textcolor{keyword}{as} lang
00022 
00023 \textcolor{keyword}{from} \hyperlink{namespaceELO_1_1models}{ELO.models} \textcolor{keyword}{import} Adm, Student, Professor
00024 \textcolor{keyword}{from} forms \textcolor{keyword}{import} (
00025     AdmRegStu\_ProfForm,
00026     AdmDelStu\_ProfForm,
00027     confAdm,
00028     AdmRegCourForm,
00029     AdmSrcCourForm,
00030     AdmDelCourForm)
00031 
00032 \textcolor{keyword}{from} django.shortcuts \textcolor{keyword}{import} render
00033 \textcolor{keyword}{from} django.conf \textcolor{keyword}{import} settings
00034 \textcolor{keyword}{from} django.http \textcolor{keyword}{import} HttpResponseRedirect
00035 \textcolor{keyword}{from} django \textcolor{keyword}{import} forms
00036 
00037 
00038 \textcolor{comment}{## Interface para a camada de apresentação de Usuário do módulo de Adm.}
00039 \textcolor{comment}{#   É responsável pelo carregamento do template correto e processa os dados}
00040 \textcolor{comment}{#   inseridos no formulário de Administração.}
\hypertarget{AdmUnit_8py_source_l00041}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm}{00041} \textcolor{keyword}{class }\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm}{IfUiAdm}:
00042     \_\_metaclass\_\_ = ABCMeta
00043     
00044     \textcolor{comment}{# Construtor da classe.}
00045     \textcolor{comment}{#   Força a criação da camada subjacente.}
\hypertarget{AdmUnit_8py_source_l00046}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_a971d8248262cb673fcbb104fa416f5ba}{00046}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_a971d8248262cb673fcbb104fa416f5ba}{\_\_init\_\_}(self, bus):
00047         \textcolor{keywordflow}{try}:
\hypertarget{AdmUnit_8py_source_l00048}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_a604bb1c41014e85eee44db64a79a7fcc}{00048}             self.\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_a604bb1c41014e85eee44db64a79a7fcc}{bus} = bus
00049         \textcolor{keywordflow}{except} TypeError \textcolor{keyword}{as} exc:
00050             del self
00051             \textcolor{keywordflow}{raise} exc
00052 
00053     \textcolor{comment}{## Objeto que representa a camada de negócio, subjacente a de UI.}
00054     \textcolor{comment}{#   Deve ser inicializada no momento da criação de um objeto do tipo}
00055     \textcolor{comment}{#   UiAdm, ou seja, uma camada de UI nunca existirá sem uma camada}
00056     \textcolor{comment}{#   de Bus suportando-a.}
00057     @property
\hypertarget{AdmUnit_8py_source_l00058}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_a6846282d9a13a62cfe54639b6ee121f8}{00058}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_a604bb1c41014e85eee44db64a79a7fcc}{bus}(self):
00059         \textcolor{keywordflow}{return} self.\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_adf49041050fd2ce5fef85b0698f331e5}{\_\_bus}
00060 
00061     \textcolor{comment}{## Checa se o objeto recebido é uma instância do Business.}
00062     \textcolor{comment}{#   Caso contrário, ele emite um erro de tipo, explicitando}
00063     \textcolor{comment}{#   qual tipo do objeto que foi recebido.}
00064     @bus.setter
\hypertarget{AdmUnit_8py_source_l00065}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_a7fd2fe0a69d29fe49668381ae5cb4e08}{00065}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_a604bb1c41014e85eee44db64a79a7fcc}{bus}(self, value):
00066         \textcolor{keywordflow}{if} isinstance(value, IfBusAdm):
00067             self.\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_adf49041050fd2ce5fef85b0698f331e5}{\_\_bus} = value
00068         \textcolor{keywordflow}{else}:
00069             \textcolor{keywordflow}{raise} TypeError(\textcolor{stringliteral}{"Expected IfBusAdm instance at \(\backslash\)}
00070 \textcolor{stringliteral}{                UiAdm.\_\_bus. Received "} + str(type(value)) + \textcolor{stringliteral}{" instead."})
00071 
00072     \textcolor{comment}{## Método de deleção do objeto que representa a camada de negócio.}
00073     @bus.deleter
\hypertarget{AdmUnit_8py_source_l00074}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_a6846282d9a13a62cfe54639b6ee121f8}{00074}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_a604bb1c41014e85eee44db64a79a7fcc}{bus}(self):
00075         del self.\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_adf49041050fd2ce5fef85b0698f331e5}{\_\_bus}
00076 
00077     \textcolor{comment}{## O método principal de qualquer classe de UI (User Interface).}
00078     \textcolor{comment}{#   O método run() permite à Factory dar o controle do programa }
00079     \textcolor{comment}{#   ao módulo de Administração.}
00080     @abstractmethod
\hypertarget{AdmUnit_8py_source_l00081}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_ad2879ed80544aa2a153c7eeed3a09a52}{00081}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm_ad2879ed80544aa2a153c7eeed3a09a52}{run}(self, request, action=None, model=None): \textcolor{keyword}{pass}
00082 
00083 \textcolor{comment}{## Interface para a camada de negócio do módulo de Administração.}
00084 \textcolor{comment}{#   É responsável pela validação dos dados submetidos através do }
00085 \textcolor{comment}{#   formulário de Administração.}
\hypertarget{AdmUnit_8py_source_l00086}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm}{00086} \textcolor{keyword}{class }\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm}{IfBusAdm}:
00087     \_\_metaclass\_\_ = ABCMeta
00088 
00089     \textcolor{comment}{## Construtor da classe.}
00090     \textcolor{comment}{#   Força a criação da camada subjacente.}
\hypertarget{AdmUnit_8py_source_l00091}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a9d8de1bb17559a720c87dcbf7bafa5bd}{00091}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a9d8de1bb17559a720c87dcbf7bafa5bd}{\_\_init\_\_}(self, pers):
00092         \textcolor{keywordflow}{try}:
\hypertarget{AdmUnit_8py_source_l00093}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a95ea8f39fbbcddf44822e1614c712bfe}{00093}             self.\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a95ea8f39fbbcddf44822e1614c712bfe}{pers} = pers
00094         \textcolor{keywordflow}{except} TypeError \textcolor{keyword}{as} exc:
00095             del self
00096             \textcolor{keywordflow}{raise} exc
00097     
00098     \textcolor{comment}{## Objeto que representa a camada de persistência, subjacente a de Bus.}
00099     \textcolor{comment}{#   Deve ser inicializada no momento da criação de um objeto do tipo}
00100     \textcolor{comment}{#   BusAdm, ou seja, uma camada de Bus nunca existirá sem uma camada}
00101     \textcolor{comment}{#   de Pers suportando-a.}
00102     @property
\hypertarget{AdmUnit_8py_source_l00103}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a58f07186cfb366e305adbbd4f7fd2b72}{00103}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a95ea8f39fbbcddf44822e1614c712bfe}{pers}(self):
00104         \textcolor{keywordflow}{return} self.\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a52e9179e1047122bc667c1afa377c82c}{\_\_pers}
00105 
00106     \textcolor{comment}{## Checa se o objeto recebido é uma instância da Persistência.}
00107     \textcolor{comment}{#   Caso contrário, ele emite um erro de tipo, explicitando}
00108     \textcolor{comment}{#   qual tipo do objeto que foi recebido.}
00109     @pers.setter
\hypertarget{AdmUnit_8py_source_l00110}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a0022f3706dcdb0d5c2795daafc2478df}{00110}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a95ea8f39fbbcddf44822e1614c712bfe}{pers}(self, value):
00111         \textcolor{keywordflow}{if} isinstance(value, IfPersAdm):
00112             self.\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a52e9179e1047122bc667c1afa377c82c}{\_\_pers} = value
00113         \textcolor{keywordflow}{else}:
00114             \textcolor{keywordflow}{raise} TypeError(\textcolor{stringliteral}{"Expected IfPersAdm instance at \(\backslash\)}
00115 \textcolor{stringliteral}{                BusAdm.\_\_pers. Received "} + str(type(value)) + \textcolor{stringliteral}{" instead."})
00116 
00117     \textcolor{comment}{## Método de deleção do objeto que representa a camada de persistência.}
00118     @pers.deleter   
\hypertarget{AdmUnit_8py_source_l00119}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a58f07186cfb366e305adbbd4f7fd2b72}{00119}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a95ea8f39fbbcddf44822e1614c712bfe}{pers}(self):
00120         del self.\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a52e9179e1047122bc667c1afa377c82c}{\_\_pers}
00121 
00122     \textcolor{comment}{## Edita dados de um conta no database.}
00123     \textcolor{comment}{#   Podendo ser este de uma conta de Estudante, Professor ou um Curso.}
00124     \textcolor{comment}{#}
00125     \textcolor{comment}{#   @arg field      Nome do objeto a ser registrado.}
00126     \textcolor{comment}{#}
00127     \textcolor{comment}{#   @arg form       Objeto form que contém os dados.}
00128     @abstractmethod
\hypertarget{AdmUnit_8py_source_l00129}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a01c6dd1137af994627462fab498b56e7}{00129}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm_a01c6dd1137af994627462fab498b56e7}{editAccounts}(self, dict\_field\_value, action, database, form): \textcolor{keyword}{pass}
00130 
00131     \textcolor{comment}{## Verifica os últimos eventos realizados pelo Administrador.}
00132     \textcolor{comment}{#@abstractmethod}
00133     \textcolor{comment}{#def checkEvents(self, request): pass}
00134     
00135 
00136 \textcolor{comment}{## Interface para a camada de persistência do módulo de Administração.}
00137 \textcolor{comment}{#   É responsável pela manipulação dos dados do sistema do banco}
00138 \textcolor{comment}{#   de dados.}
\hypertarget{AdmUnit_8py_source_l00139}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfPersAdm}{00139} \textcolor{keyword}{class }\hyperlink{classAdm_1_1AdmUnit_1_1IfPersAdm}{IfPersAdm}:
00140     \_\_metaclass\_\_ = ABCMeta
00141 
00142     \textcolor{comment}{## Insere os dados do registro de contas no banco de dados.}
00143     \textcolor{comment}{#   Contas dos tipos Estudantes e Professores, e cursos.}
00144     \textcolor{comment}{#}
00145     \textcolor{comment}{#   @arg    dict\_field  Dicionário de campos ligados a valores.}
00146     \textcolor{comment}{#}
00147     \textcolor{comment}{#   @arg    database    Objeto modelo sobre o qual a inserção será}
00148     \textcolor{comment}{#                       realizada (Estudante, Professor, Curso). }
00149     @abstractmethod
\hypertarget{AdmUnit_8py_source_l00150}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfPersAdm_abf01de08eb9d6517cdcb44321ea12ce7}{00150}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfPersAdm_abf01de08eb9d6517cdcb44321ea12ce7}{data\_in}(self, dict\_field\_value, database): \textcolor{keyword}{pass}
00151 
00152     \textcolor{comment}{## Método que atualiza os dados de uma conta fornecida.}
00153     \textcolor{comment}{#   No caso de campos multivalorados, adiciona uma nova entrada.}
00154     \textcolor{comment}{#   Caso contrário, substitui a entrada anterior.}
00155     \textcolor{comment}{#   É necessário a senha do administrador para que}
00156     \textcolor{comment}{#   essa operação possa ser executada.}
00157     \textcolor{comment}{#}
00158     \textcolor{comment}{#   @arg    username    Nome do usuário sobre o qual a consulta será}
00159     \textcolor{comment}{#                       realizada.}
00160     \textcolor{comment}{#   @arg    field       Campo a ser atualizado.}
00161     \textcolor{comment}{#}
00162     \textcolor{comment}{#   @arg    newdata     Dado a ser atualizado.}
00163     \textcolor{comment}{#}
00164     \textcolor{comment}{#   @arg    database    Objeto de modelo que será utilizado.}
00165     @abstractmethod
\hypertarget{AdmUnit_8py_source_l00166}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfPersAdm_a34acb7c8c60b0e90429cfbcc28424852}{00166}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfPersAdm_a34acb7c8c60b0e90429cfbcc28424852}{update}(self, username, field, newdata, database): \textcolor{keyword}{pass}
00167 
00168     \textcolor{comment}{## Método que deleta os dados de uma conta fornecida.}
00169     \textcolor{comment}{#   É necessário a senha do administrador para que}
00170     \textcolor{comment}{#   essa operação possa ser executada.}
00171     \textcolor{comment}{#}
00172     \textcolor{comment}{#   @arg    username    Nome da conta a ser deletada.}
00173     \textcolor{comment}{#}
00174     \textcolor{comment}{#   @arg    database    Objeto modelo sobre o qual a consulta será}
00175     \textcolor{comment}{#                       realizada.}
00176     @abstractmethod
\hypertarget{AdmUnit_8py_source_l00177}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfPersAdm_a6e9771c86560ed5b7d38fbf6bd40cec8}{00177}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfPersAdm_a6e9771c86560ed5b7d38fbf6bd40cec8}{fetch\_del}(self, username, database): \textcolor{keyword}{pass}
00178 
00179     \textcolor{comment}{##  Função que recupera todos os dados do usuário.}
00180     \textcolor{comment}{#       Percorre o banco de dados e recupera todos os dados do usuário}
00181     \textcolor{comment}{#       requisitado.}
00182     \textcolor{comment}{#}
00183     \textcolor{comment}{#   @arg    username    Nome do usuário a ser pesquisado.}
00184     \textcolor{comment}{#}
00185     \textcolor{comment}{#   @arg    database    Objeto modelo sobre o qual a consulta será}
00186     \textcolor{comment}{#                       realizada.}
00187     @abstractmethod
\hypertarget{AdmUnit_8py_source_l00188}{}\hyperlink{classAdm_1_1AdmUnit_1_1IfPersAdm_ac439faae9802d9828eee269548ff2661}{00188}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1IfPersAdm_ac439faae9802d9828eee269548ff2661}{fetch}(self, username, database): \textcolor{keyword}{pass}
00189 
00190 
00191 \textcolor{comment}{## Camada de interface do Administrador para o módulo de Administração.}
00192 \textcolor{comment}{#   Deve carregar o devido template, contendo campos onde será}
00193 \textcolor{comment}{#   permitido a criação, edição e deleção de contas do tipo Estudante,}
00194 \textcolor{comment}{#   Professor e Cursos.}
00195 \textcolor{comment}{#   Caso seja feito o pedido de alteração em qualquer condição}
00196 \textcolor{comment}{#   citada acima então será chamada uma caixa com formulários}
00197 \textcolor{comment}{#   requisitando os devidos dados necessários de cada ação.}
\hypertarget{AdmUnit_8py_source_l00198}{}\hyperlink{classAdm_1_1AdmUnit_1_1UiAdm}{00198} \textcolor{keyword}{class }\hyperlink{classAdm_1_1AdmUnit_1_1UiAdm}{UiAdm}(\hyperlink{classAdm_1_1AdmUnit_1_1IfUiAdm}{IfUiAdm}): 
00199 
00200     \textcolor{comment}{## O método principal de qualquer classe de UI (User Interface).}
\hypertarget{AdmUnit_8py_source_l00201}{}\hyperlink{classAdm_1_1AdmUnit_1_1UiAdm_a88df3b19b48d71b2c0fc0b4557c71416}{00201}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1UiAdm_a88df3b19b48d71b2c0fc0b4557c71416}{run}(self, request, action=None, model=None):
00202         \textcolor{comment}{## @if Verifica qual o propósito do submit.}
00203         \textcolor{comment}{#   Caso seja POST, a requisição ocorre após a submissão de uma form,}
00204         \textcolor{comment}{#       podendo ser ela de registro, edição ou deleção.}
00205         \textcolor{comment}{#   Caso não seja e não ocorra a passagem dos campos de ação e modelo,}
00206         \textcolor{comment}{#       a requisição há de ser um GET, para mostrar a página principal}
00207         \textcolor{comment}{#       de Adm.}
00208         \textcolor{comment}{#   Em último caso será a requisição do Javascript, denominada como }
00209         \textcolor{comment}{#       AJAX, que irá solicitar em tempo de evento dos dialogs }
00210         \textcolor{comment}{#       iniciados.}
00211         \textcolor{comment}{#   Será passada informações para requisitar os forms adequados e }
00212         \textcolor{comment}{#       informações do usuário procurado para uma possível edição ou }
00213         \textcolor{comment}{#       deleção.}
00214         \textcolor{keywordflow}{if} request.method == \textcolor{stringliteral}{"POST"}:
00215 
00216             \textcolor{comment}{#--------------------------sugestões do tio Yurick}
00217             \textcolor{comment}{# sugestão de como fazer essa verificação, mas pode fazer do jeito}
00218             \textcolor{comment}{# que preferir}
00219 
00220             \textcolor{keywordflow}{if} \textcolor{stringliteral}{'type'} \textcolor{keywordflow}{in} request.POST \textcolor{keywordflow}{and} request.POST[\textcolor{stringliteral}{'type'}] == \textcolor{stringliteral}{'info'}:
00221                 \textcolor{keywordflow}{try}:
00222                     \textcolor{comment}{# pus aqui só para não precisar mudar a assinatura da}
00223                     \textcolor{comment}{# editAccounts, já que 'action' é um campo redudante}
00224                     action = \textcolor{stringliteral}{"atualizar"}
00225 
00226                     form = AdmDelStu\_ProfForm(request.POST)
00227                     \textcolor{keywordflow}{if} form.is\_valid():
00228                         \textcolor{comment}{# aconselho usar um método diferente}
00229                         \textcolor{comment}{# para recuperação de dados, bem como corrigir}
00230                         \textcolor{comment}{# os argumentos redundantes}
00231                         d\_user = self.bus.editAccounts(request.POST,
00232                                                         action,
00233                                                         Student,
00234                                                         form)
00235                         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} d\_user:
00236                             \textcolor{keywordflow}{raise} ValueError(\textcolor{stringliteral}{"TALVEZ ALGUMA MENSAGEM DE ERRO?"})
00237 
00238                         d\_user = dict(d\_user)
00239 
00240                         \textcolor{keywordflow}{return} render(request, 
00241                                       \textcolor{stringliteral}{"Adm/info.html"}, 
00242                                       \{\textcolor{stringliteral}{'data'}:d\_user\})
00243                     \textcolor{keywordflow}{else}:
00244                         \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_INV\_FRM'}])
00245                 \textcolor{keywordflow}{except} ValueError \textcolor{keyword}{as} exc:
00246                     \textcolor{comment}{# falta criar algum suporte para mensagem de erro}
00247                     \textcolor{keywordflow}{return} HttpResponseRedirect(\textcolor{stringliteral}{'/'})
00248 
00249             \textcolor{comment}{#-------------------------}
00250 
00251             \textcolor{keywordflow}{if} \textcolor{stringliteral}{"registrar"} \textcolor{keywordflow}{in} request.POST:
00252                 \textcolor{keywordflow}{try}:
00253                     \textcolor{comment}{# Coleta os forms adequados a partir da requisição POST.}
00254                     form = AdmRegStu\_ProfForm(request.POST)
00255 
00256                     \textcolor{comment}{# Se form for adequado então é chamado o método de edição }
00257                     \textcolor{comment}{#   de contas que irá comunicar-se com o banco de dados }
00258                     \textcolor{comment}{#   depois de uma validação das informações passadas pelo}
00259                     \textcolor{comment}{#   request.POST.}
00260                     \textcolor{keywordflow}{if} form.is\_valid():
00261                         self.bus.editAccounts(request.POST,action, Student, form)
00262                     \textcolor{comment}{# Caso contrário irá surgir um erro de que há dados}
00263                     \textcolor{comment}{#   incorretos.}
00264                     \textcolor{keywordflow}{else}:
00265                         \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_INV\_FRM'}])
00266                 \textcolor{comment}{# Se houver qualquer problema referente as passagens dos forms }
00267                 \textcolor{comment}{#   e conferência da validação dos mesmos então o }
00268                 \textcolor{comment}{#   administrador será passado para a página inicial.}
00269                 \textcolor{keywordflow}{except} ValueError \textcolor{keyword}{as} exc:
00270                     \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Adm/home.html"})
00271             \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"atualizar"} \textcolor{keywordflow}{in} request.POST:
00272                 d\_user = self.bus.editAccounts(request.POST, \textcolor{stringliteral}{"atualizar"}, Student, form = \textcolor{keywordtype}{None})
00273                 data = dict(d\_user)
00274 
00275                 \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Adm/info.html"}, \{\textcolor{stringliteral}{'data'} : data\})
00276             
00277             \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"apagar"} \textcolor{keywordflow}{in} request.POST:
00278                 d\_user = self.bus.editAccounts(request.POST, \textcolor{stringliteral}{"apagar"}, Student, form = \textcolor{keywordtype}{None})
00279                 data = dict(d\_user)
00280 
00281                 \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Adm/info.html"}, \{\textcolor{stringliteral}{'data'} : data\})
00282 
00283             \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"name"} \textcolor{keywordflow}{in} request.POST:
00284                 form = NameForm(request.POST)
00285                 field = \textcolor{stringliteral}{"name"}
00286             \textcolor{keywordflow}{elif}  \textcolor{stringliteral}{"password"} \textcolor{keywordflow}{in} request.POST:
00287                 form = PasswordForm(request.POST)
00288                 field = \textcolor{stringliteral}{"password"}
00289             \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"language"} \textcolor{keywordflow}{in} request.POST:
00290                 form = LanguageForm(request.POST)
00291                 field = \textcolor{stringliteral}{"language"}
00292             \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"sex"} \textcolor{keywordflow}{in} request.POST:
00293                 form = SexForm(request.POST)
00294                 field = \textcolor{stringliteral}{"sex"}
00295             \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"bios"} \textcolor{keywordflow}{in} request.POST:
00296                 form = BiosForm(request.POST)
00297                 field = \textcolor{stringliteral}{"bios"}
00298             \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"interests"} \textcolor{keywordflow}{in} request.POST:
00299                 form = InterestsForm(request.POST)
00300                 field = \textcolor{stringliteral}{"interests"}
00301             \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"avatar"} \textcolor{keywordflow}{in} request.POST:
00302                 form = AvatarForm(request.POST, request.FILES)
00303                 field = \textcolor{stringliteral}{"avatar"}
00304             \textcolor{keywordflow}{else}:
00305                 \textcolor{comment}{#raise ValueError(lang.DICT['EXCEPTION\_INV\_FRM'])}
00306                 \textcolor{keywordflow}{return} HttpResponseRedirect(\textcolor{stringliteral}{'/'})
00307             \textcolor{keywordflow}{if} form.is\_valid():
00308                 self.bus.editAccounts(request.POST, field, Student, form)
00309                 request.session.modified = \textcolor{keyword}{True}                
00310 
00311             \textcolor{comment}{# Após a coleta da requisição o administrador será retornado à página inicial de controle.}
00312             \textcolor{keywordflow}{return} HttpResponseRedirect(\textcolor{stringliteral}{'/'})
00313 
00314         \textcolor{comment}{# Quando a requisição for de GET então é retornado para a página principal.                        
                         }
00315         \textcolor{keywordflow}{else}:
00316             \textcolor{comment}{# Chamada normal de GET.}
00317             \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} (action \textcolor{keywordflow}{or} model):
00318                 \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Adm/home.html"})
00319             \textcolor{comment}{# Caso contrário, no caso de requisições do tipo AJAX, }
00320             \textcolor{comment}{#   irá ser repassado forms adequados ao pedido ou será feito}
00321             \textcolor{comment}{#   buscas de dados do usuário requisitado.}
00322             \textcolor{keywordflow}{else}:
00323                 \textcolor{keywordflow}{if} action == \textcolor{stringliteral}{"reg"}:
00324                     form = AdmRegStu\_ProfForm()
00325                 \textcolor{keywordflow}{elif} action == \textcolor{stringliteral}{"att"} \textcolor{keywordflow}{or} action == \textcolor{stringliteral}{"del"}:
00326                     form = AdmDelStu\_ProfForm()
00327                 \textcolor{keywordflow}{else}:
00328                     form = lang.DICT[\textcolor{stringliteral}{"ERROR\_FORM"}]
00329                 \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Adm/edit.html"}, \{\textcolor{stringliteral}{'form'}: form,
00330                                                          \textcolor{stringliteral}{'action'} : action,
00331                                                         \})
00332 
00333 
00334 
00335 
00336 \textcolor{comment}{## Camada de negócio para o módulo de administração.}
00337 \textcolor{comment}{#   Deve ser capaz de manipular os dados do sistema,}
00338 \textcolor{comment}{#   dando as devidas diretrizes ao banco de dados para que seja}
00339 \textcolor{comment}{#   inserido, atualizado ou deletado dados sobre uma determinada}
00340 \textcolor{comment}{#   conta, podendo ser esta de um Estudante, Professor ou de um Curso.}
\hypertarget{AdmUnit_8py_source_l00341}{}\hyperlink{classAdm_1_1AdmUnit_1_1BusAdm}{00341} \textcolor{keyword}{class }\hyperlink{classAdm_1_1AdmUnit_1_1BusAdm}{BusAdm}(\hyperlink{classAdm_1_1AdmUnit_1_1IfBusAdm}{IfBusAdm}): 
00342 
00343     \textcolor{comment}{## Edita dados de um conta no database.}
00344     \textcolor{comment}{#   Podendo ser este de uma conta de Estudante, Professor ou um Curso.}
\hypertarget{AdmUnit_8py_source_l00345}{}\hyperlink{classAdm_1_1AdmUnit_1_1BusAdm_a54984f999b27cdce51914ed05cd7cb42}{00345}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1BusAdm_a54984f999b27cdce51914ed05cd7cb42}{editAccounts}(self, dict\_field\_value, action, database, form):
00346         
00347         \textcolor{comment}{# Inicia o dicionário dict\_data.}
00348         \textcolor{comment}{#   Será utilizado para informar os campos e dados para registro do usuário.}
00349         dict\_data = \{\}
00350         database\_fields = [\textcolor{stringliteral}{'NAME'}, \textcolor{stringliteral}{'SEX'}, \textcolor{stringliteral}{'PASSWORD'}, \textcolor{stringliteral}{'MATRIC'}, \textcolor{stringliteral}{'CAMPUS'},\textcolor{stringliteral}{'EMAIL'}]
00351 
00352         \textcolor{comment}{# Se for uma ação de registro do usuário.}
00353         \textcolor{keywordflow}{if} action == \textcolor{stringliteral}{"registrar"}: 
00354             \textcolor{comment}{# Percorre os campos e valores coletador no request.POST.}
00355             \textcolor{keywordflow}{for} field, value \textcolor{keywordflow}{in} dict\_field\_value.items():
00356                 \textcolor{comment}{# Transforma os unicodes do dicionário em strings.}
00357                 field = str(field)
00358                 \textcolor{comment}{# Coleta a palavra chave do campo designado.}
00359                 \textcolor{comment}{#   Esta é coletada a partir dos campos contidos no dicionário.}
00360                 newField = field[4:].upper()
00361 
00362                 \textcolor{comment}{# Se o campo encontrado pertence à lista de campos do database que deveriam}
00363                 \textcolor{comment}{# pertencer a um usuário, então este é adicionado ao dicionário que será}
00364                 \textcolor{comment}{# repassado para inserção no banco de dados posteriormente.}
00365                 \textcolor{keywordflow}{if} newField \textcolor{keywordflow}{in} database\_fields:
00366                     dict\_data[newField] = form.cleaned\_data[field].value
00367 
00368             \textcolor{comment}{# Escolhe uma linguagem padrão para cadastro de um usuário qualquer.}
00369             dict\_data[\textcolor{stringliteral}{'LANGUAGE'}] = \textcolor{stringliteral}{'en'}
00370 
00371             \textcolor{comment}{# Se for uma entidade estudante então é feito o pedido de inserção }
00372             \textcolor{comment}{# no banco de dados com o determinado modelo.}
00373             \textcolor{keywordflow}{if} database.\_\_name\_\_ == \textcolor{stringliteral}{"Student"}:
00374                 self.pers.data\_in(dict\_data, database)
00375 
00376         \textcolor{keywordflow}{elif} action == \textcolor{stringliteral}{"atualizar"}:
00377             data = self.pers.fetch(dict\_field\_value[\textcolor{stringliteral}{'username'}], Student)
00378 
00379             \textcolor{keywordflow}{return} data
00380 
00381         \textcolor{keywordflow}{elif} action == \textcolor{stringliteral}{"apagar"}:
00382             data = self.pers.fetch(dict\_field\_value[\textcolor{stringliteral}{'username'}], Student)
00383 
00384             \textcolor{keywordflow}{return} data
00385 
00386         \textcolor{keywordflow}{elif} action == \textcolor{stringliteral}{"name"}:
00387             fpw = form.cleaned\_data[\textcolor{stringliteral}{'password'}].value
00388             \textcolor{keywordflow}{if} fpw != user[\textcolor{stringliteral}{'password'}]:
00389                 \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_INV\_PW\_F'}])
00390             newdata = form.cleaned\_data[\textcolor{stringliteral}{'newdata'}].value
00391         \textcolor{keywordflow}{elif} action == \textcolor{stringliteral}{"password"}:
00392             npw = form.cleaned\_data[\textcolor{stringliteral}{'newdata'}].value
00393             rpw = form.cleaned\_data[\textcolor{stringliteral}{'rp\_newdata'}].value
00394             opw = form.cleaned\_data[\textcolor{stringliteral}{'old\_password'}].value
00395             \textcolor{keywordflow}{if} npw != rpw:
00396                 \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_INV\_PW\_R'}])
00397             \textcolor{keywordflow}{if} opw != user[\textcolor{stringliteral}{'password'}]:
00398                 \textcolor{keywordflow}{raise} ValueError(lang.DICt[\textcolor{stringliteral}{'EXCEPTION\_INV\_PW\_F'}])
00399             newdata = npw
00400         \textcolor{keywordflow}{elif} action == \textcolor{stringliteral}{"language"}:
00401             newdata = form.cleaned\_data[\textcolor{stringliteral}{'newdata'}]
00402         \textcolor{keywordflow}{elif} action == \textcolor{stringliteral}{"avatar"}:
00403             addr = settings.MEDIA\_ROOT + \textcolor{stringliteral}{u"/"} + user[\textcolor{stringliteral}{'avatar'}]
00404             with open(addr, \textcolor{stringliteral}{"wb"}) \textcolor{keyword}{as} destination:
00405                     \textcolor{keywordflow}{for} chunk \textcolor{keywordflow}{in} request.FILES[\textcolor{stringliteral}{'newdata'}].chunks():
00406                         destination.write(chunk)
00407         \textcolor{keywordflow}{else}:
00408             newdata = form.cleaned\_data[\textcolor{stringliteral}{'newdata'}].value
00409 
00410         \textcolor{keywordflow}{try}:
00411             self.pers.update(user[\textcolor{stringliteral}{'name'}], field, newdata, Student)
00412         \textcolor{keywordflow}{except} ValueError \textcolor{keyword}{as} exc:
00413             \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_ERR\_DB\_U'}])
00414 
00415 
00416 \textcolor{comment}{## Camada de persistência para o módulo de administração.}
00417 \textcolor{comment}{#   Insere, atualiza ou deleta dados do banco de dados referentes aos }
00418 \textcolor{comment}{#   alunos professores e cursos.}
\hypertarget{AdmUnit_8py_source_l00419}{}\hyperlink{classAdm_1_1AdmUnit_1_1PersAdm}{00419} \textcolor{keyword}{class }\hyperlink{classAdm_1_1AdmUnit_1_1PersAdm}{PersAdm}(\hyperlink{classAdm_1_1AdmUnit_1_1IfPersAdm}{IfPersAdm}):
00420 
00421     \textcolor{comment}{## Insere os dados do registro de contas no banco de dados.}
\hypertarget{AdmUnit_8py_source_l00422}{}\hyperlink{classAdm_1_1AdmUnit_1_1PersAdm_ab9b66eb770103a270de417a6b936ad21}{00422}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1PersAdm_ab9b66eb770103a270de417a6b936ad21}{data\_in}(self, dict\_field\_value, database):
00423         \textcolor{comment}{# Tenta coletar o último id inserido.}
00424         \textcolor{comment}{# Caso não tenha ocorrido nenhum registro de contas então}
00425         \textcolor{comment}{# é atribuído o valor inicial como '1'}
00426         \textcolor{keywordflow}{try}:
00427             \textcolor{comment}{# Coleta o ultimo ID inserido no identity do database.}
00428             lastid = database.objects.order\_by(\textcolor{stringliteral}{'-identity'})[0]
00429             \textcolor{comment}{# Newid será a identity do novo usuário.}
00430             newid = lastid.identity + 1
00431         \textcolor{keywordflow}{except} IndexError:
00432             newid = 1
00433         
00434         \textcolor{comment}{# Percorre o dicionário ligado aos campos a seu valores.}
00435         \textcolor{keywordflow}{for} fields \textcolor{keywordflow}{in} dict\_field\_value:
00436             \textcolor{comment}{# Insere novos dados: identidade, campo e a novo valor.}
00437             data = database(identity=newid, field=fields,
00438                              value=dict\_field\_value[fields])
00439             \textcolor{comment}{# Salva os novos dados no database.}
00440             data.save()
00441 
00442     \textcolor{comment}{## Método que atualiza os dados de uma conta fornecida.}
\hypertarget{AdmUnit_8py_source_l00443}{}\hyperlink{classAdm_1_1AdmUnit_1_1PersAdm_a65d586fd8aaf0a9f2f7c609405721dff}{00443}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1PersAdm_a65d586fd8aaf0a9f2f7c609405721dff}{update}(self, username, field, newdata, database): 
00444         \textcolor{comment}{# Tenta procurar se o username existe no banco de dados.}
00445         \textcolor{comment}{# Caso não exista, é emitido um erro.}
00446         \textcolor{keywordflow}{try}:
00447             \textcolor{comment}{# Filtra o database pelo nome do usuario.}
00448             uid = database.objects.get(field=\textcolor{stringliteral}{'NAME'}, value=username)
00449             \textcolor{comment}{# Coleta a ID do usuário encontrado.}
00450             uid = uid.identity
00451                 
00452             \textcolor{keywordflow}{try}:
00453                 \textcolor{comment}{# Coleta a partir do ID do usuário o valor do campo}
00454                 \textcolor{comment}{# que deseja atualizar.}
00455                 data = database.objects.get(identity=uid, field=field.upper())
00456                 \textcolor{comment}{# Nova informação é colocada no tipo que deseja atualizar.}
00457                 data.value = newdata
00458             \textcolor{comment}{# Caso o novo valor a ser colocado já exista então este continua o mesmo.}
00459             \textcolor{keywordflow}{except} database.DoesNotExist:
00460                 data = database(identity=uid, field=field.upper(), value=newdata)
00461             \textcolor{comment}{# Salva os novos dados no database.}
00462             data.save()
00463 
00464         \textcolor{keywordflow}{except} ( database.DoesNotExist, 
00465                  database.MultipleObjectsReturned ) \textcolor{keyword}{as} exc:
00466             \textcolor{keywordflow}{raise} ValueError(exc)
00467 
00468     \textcolor{comment}{## Método que deleta os dados de uma conta fornecida.}
\hypertarget{AdmUnit_8py_source_l00469}{}\hyperlink{classAdm_1_1AdmUnit_1_1PersAdm_a2b5453709dfc3b1c6e5f9f85dc61d228}{00469}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1PersAdm_a2b5453709dfc3b1c6e5f9f85dc61d228}{fetch\_del}(self, username, database):
00470         \textcolor{comment}{# Tenta procurar se o username existe no banco de dados.}
00471         \textcolor{comment}{# Caso não exista, é emitido um erro.}
00472         \textcolor{keywordflow}{try}:
00473             \textcolor{comment}{# Filtra o database pelo nome do usuario.}
00474             uid = database.objects.get(field=\textcolor{stringliteral}{'NAME'},value=username)
00475             \textcolor{comment}{# Coleta a ID do usuário}
00476             uid = uid.identity
00477 
00478         \textcolor{comment}{# Caso usuário não exista, então é retornado para o Business}
00479         \textcolor{comment}{# que não foi encontrado.}
00480         \textcolor{keywordflow}{except} database.DoesNotExist:
00481             \textcolor{keywordflow}{return} \textcolor{keyword}{False}
00482 
00483         \textcolor{comment}{# Tenta filtrar os dados de um ID.}
00484         \textcolor{comment}{# Caso não exista, é emitido um erro.}
00485         \textcolor{keywordflow}{try}:   
00486             \textcolor{comment}{# Lista da filtragem dos dados de um determinado ID.}
00487             accdel = database.objects.filter(identity=uid)
00488             \textcolor{comment}{# Lista dos dados é deletada do database.}
00489             accdel.delete()
00490        
00491         \textcolor{keywordflow}{except} ( database.DoesNotExist, 
00492                 database.MultipleObjectsReturned ) \textcolor{keyword}{as} exc:
00493             \textcolor{keywordflow}{raise} ValueError(exc)
00494 
00495     \textcolor{keyword}{def }\_\_select\_field(self, uid, field, database):
00496 
00497         \textcolor{keywordflow}{try}:
00498             ret = database.objects.get(identity=uid, field=field)
00499             ret = ret.value
00500 
00501         \textcolor{keywordflow}{except} database.MultipleObjectsReturned:
00502             ret = map(\textcolor{keyword}{lambda} x: x.value, database.objects.filter(
00503                     identity=uid, field=field))
00504 
00505         \textcolor{keywordflow}{except} database.DoesNotExist:
00506             ret = \textcolor{keywordtype}{None} 
00507 
00508         \textcolor{keywordflow}{return} ret
00509 
00510     \textcolor{comment}{##  Função que recupera todos os dados do usuário.}
\hypertarget{AdmUnit_8py_source_l00511}{}\hyperlink{classAdm_1_1AdmUnit_1_1PersAdm_a0813f79d2ef26ab014c21f4ae2217045}{00511}     \textcolor{keyword}{def }\hyperlink{classAdm_1_1AdmUnit_1_1PersAdm_a0813f79d2ef26ab014c21f4ae2217045}{fetch}(self, username, database):
00512 
00513         \textcolor{keywordflow}{try}:
00514             uid = database.objects.get(field=\textcolor{stringliteral}{'NAME'},value=username)
00515             uid = uid.identity
00516 
00517             sf = \textcolor{keyword}{lambda} x: self.\hyperlink{classAdm_1_1AdmUnit_1_1PersAdm_aa30c5e73f6bfa1c525007624caebaaa3}{\_\_select\_field}(uid, x, database)
00518 
00519             fetchset = [
00520                     (\textcolor{stringliteral}{'password'},    sf(\textcolor{stringliteral}{'PASSWORD'})),
00521                     (\textcolor{stringliteral}{'matric'},      sf(\textcolor{stringliteral}{'MATRIC'})),
00522                     (\textcolor{stringliteral}{'bios'},        sf(\textcolor{stringliteral}{'BIOS'})),
00523                     (\textcolor{stringliteral}{'campus'},      sf(\textcolor{stringliteral}{'CAMPUS'})),
00524                     (\textcolor{stringliteral}{'courses'},     sf(\textcolor{stringliteral}{'COURSE'})),
00525                     (\textcolor{stringliteral}{'avatar'},      sf(\textcolor{stringliteral}{'AVATAR'})),
00526                     (\textcolor{stringliteral}{'email'},       sf(\textcolor{stringliteral}{'EMAIL'})),
00527                     (\textcolor{stringliteral}{'sex'},         sf(\textcolor{stringliteral}{'SEX'})),
00528             ]
00529 
00530             \textcolor{keywordflow}{if} database \textcolor{keywordflow}{is} Student:
00531                 fetchset = fetchset + [     
00532                     (\textcolor{stringliteral}{'grades'},      sf(\textcolor{stringliteral}{'GRADE'})),
00533                     (\textcolor{stringliteral}{'interests'},   sf(\textcolor{stringliteral}{'INTEREST'})),
00534                     (\textcolor{stringliteral}{'language'},    sf(\textcolor{stringliteral}{'LANGUAGE'})),
00535                 ]
00536 
00537         \textcolor{keywordflow}{except} database.DoesNotExist \textcolor{keyword}{as} exc:
00538             fetchset = []
00539 
00540         \textcolor{keywordflow}{return} fetchset
00541 
00542 
\end{DoxyCode}
