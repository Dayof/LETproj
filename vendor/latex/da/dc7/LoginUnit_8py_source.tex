\hypertarget{LoginUnit_8py}{\subsection{Login\-Unit.\-py}
\label{LoginUnit_8py}\index{E\-L\-O/\-Login/\-Login\-Unit.\-py@{E\-L\-O/\-Login/\-Login\-Unit.\-py}}
}

\begin{DoxyCode}
\hypertarget{LoginUnit_8py_source_l00001}{}\hyperlink{namespaceLogin_1_1LoginUnit}{00001} \textcolor{comment}{#coding: utf-8}
00002 
00003 \textcolor{comment}{## @file Armazenamento de todas as camadas correspondentes ao módulo de login.}
00004 \textcolor{comment}{#   Os métodos aqui são criados e chamados pela Factory (MainUnit.py) quando}
00005 \textcolor{comment}{#   necessários.}
00006 \textcolor{comment}{#   Eles são responsáveis pela criação, gestão e deleção do objeto de sessão e }
00007 \textcolor{comment}{#   validação e login dos usuários.}
00008 
00009 \textcolor{keyword}{from} abc \textcolor{keyword}{import} *
00010 
00011 \textcolor{keyword}{from} django.shortcuts \textcolor{keyword}{import} render
00012 \textcolor{keyword}{from} django.conf \textcolor{keyword}{import} settings
00013 \textcolor{keyword}{from} django.http \textcolor{keyword}{import} HttpResponseRedirect
00014 \textcolor{keyword}{from} django.template \textcolor{keyword}{import} Template, Context
00015 \textcolor{keyword}{from} django \textcolor{keyword}{import} forms
00016 
00017 \textcolor{keyword}{from} \hyperlink{namespaceELO_1_1models}{ELO.models} \textcolor{keyword}{import} Student, Adm, Professor
00018 \textcolor{keyword}{from} \hyperlink{namespaceELO_1_1BaseUnit}{ELO.BaseUnit} \textcolor{keyword}{import} Name, Password
00019 \textcolor{keyword}{from} \hyperlink{namespaceLogin_1_1forms}{Login.forms} \textcolor{keyword}{import} LoginForm
00020 
00021 \textcolor{keyword}{import} \hyperlink{namespaceELO_1_1locale_1_1index}{ELO.locale.index} \textcolor{keyword}{as} lang
00022 
00023 \textcolor{comment}{## Interface para a camada de Apresentação de Usuário do módulo Login.}
00024 \textcolor{comment}{#   É responsável pelo carregamento do template correto e processa os dados}
00025 \textcolor{comment}{#   inseridos no formulário de login.}
\hypertarget{LoginUnit_8py_source_l00026}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin}{00026} \textcolor{keyword}{class }\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin}{IfUiLogin}:
00027     \textcolor{comment}{## Força a criação da camada subjacente}
00028     \_\_metaclass\_\_ = ABCMeta
00029 
\hypertarget{LoginUnit_8py_source_l00030}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_a2afcef7056181566ac0e801ad8094ece}{00030}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_a2afcef7056181566ac0e801ad8094ece}{\_\_init\_\_}(self, bus):
00031         \textcolor{keywordflow}{try}:
\hypertarget{LoginUnit_8py_source_l00032}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_af6823ae4c77d340c2341932d8f338753}{00032}             self.\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_af6823ae4c77d340c2341932d8f338753}{bus} = bus
00033         \textcolor{keywordflow}{except} TypeError \textcolor{keyword}{as} exc:
00034             del self
00035             \textcolor{keywordflow}{raise} exc
00036 
00037     \textcolor{comment}{## Objeto que representa a camada de negócio, subjacente a de UI.}
00038     \textcolor{comment}{#   Deve ser inicializada no momento da criação de um objeto do tipo}
00039     \textcolor{comment}{#   UiLogin, ou seja, uma camada de UI nunca existirá sem uma camada}
00040     \textcolor{comment}{#   de Bus suportando-a.}
00041     @property
\hypertarget{LoginUnit_8py_source_l00042}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_abab63bd2085f485ca82494db8eb5f520}{00042}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_af6823ae4c77d340c2341932d8f338753}{bus}(self):
00043         \textcolor{keywordflow}{return} self.\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_a550be8bfdf4cbc495bc966484e867af2}{\_\_bus}
00044 
00045     @bus.setter
\hypertarget{LoginUnit_8py_source_l00046}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_abab63bd2085f485ca82494db8eb5f520}{00046}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_af6823ae4c77d340c2341932d8f338753}{bus}(self, value):
00047         \textcolor{keywordflow}{if} isinstance(value, IfBusLogin):
00048             self.\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_a550be8bfdf4cbc495bc966484e867af2}{\_\_bus} = value
00049         \textcolor{keywordflow}{else}:
00050             \textcolor{keywordflow}{raise} TypeError(\textcolor{stringliteral}{"Expected IfBusLogin instance at \(\backslash\)}
00051 \textcolor{stringliteral}{                    UiLogin.\_\_bus. Received "} + str(type(value)) + \textcolor{stringliteral}{" instead."})
00052 
00053     \textcolor{comment}{## Método de deleção do objeto que representa a camada de negócio.}
00054     @bus.deleter
\hypertarget{LoginUnit_8py_source_l00055}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_abab63bd2085f485ca82494db8eb5f520}{00055}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_af6823ae4c77d340c2341932d8f338753}{bus}(self):
00056         del self.\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_a550be8bfdf4cbc495bc966484e867af2}{\_\_bus}
00057 
00058     \textcolor{comment}{## O método principal de qualquer classe de UI (user interface), o método}
00059     \textcolor{comment}{#   run() permite à Factory dar o controle do programa ao módulo de Login.}
00060     @abstractmethod
\hypertarget{LoginUnit_8py_source_l00061}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_ac6250c19afa63158907c6e8b4ff6dbd5}{00061}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_ac6250c19afa63158907c6e8b4ff6dbd5}{run}(self, request): \textcolor{keyword}{pass}
00062 
00063 
00064 \textcolor{comment}{## Interface para a camada de negócio do módulo de Login.}
00065 \textcolor{comment}{#   Responsável pela validação dos dados submetidos através do formulário de}
00066 \textcolor{comment}{#   login.}
\hypertarget{LoginUnit_8py_source_l00067}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin}{00067} \textcolor{keyword}{class }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin}{IfBusLogin}: 
00068     \_\_metaclas\_\_ = ABCMeta
00069 
00070     \textcolor{comment}{## Método de validação.}
00071     \textcolor{comment}{#   Não deve retornar nada, mas lança uma exceção do tipo ValueError no}
00072     \textcolor{comment}{#   caso de uma validação mal-sucedida.}
00073     \textcolor{comment}{#}
00074     \textcolor{comment}{#   @arg username   Nome do usuário a ser validado.}
00075     \textcolor{comment}{#}
00076     \textcolor{comment}{#   @arg password   Senha a ser validada, junto ao username.}
00077     \textcolor{comment}{#}
00078     \textcolor{comment}{#   @arg database   Classe do modelo a ser utilizado.}
00079     @abstractmethod
\hypertarget{LoginUnit_8py_source_l00080}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a55078e3d16b3e0557b557aed92fd7c36}{00080}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a55078e3d16b3e0557b557aed92fd7c36}{validate}(self, username, password, database): \textcolor{keyword}{pass}
00081 
00082 
00083     \textcolor{comment}{## Método de recuperação de linguagem de sistema.}
00084     \textcolor{comment}{#   Retorna uma string com o código da linguagem preferida pelo usuário.}
00085     \textcolor{comment}{#}
00086     \textcolor{comment}{#   @arg username   Nome do usuário a ser verificado.}
00087     \textcolor{comment}{#}
00088     \textcolor{comment}{#   @arg database   Classe do modelo a ser utilizado.}
00089     @abstractmethod
\hypertarget{LoginUnit_8py_source_l00090}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a66e981f9d6fc6251de59568c1de028aa}{00090}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a66e981f9d6fc6251de59568c1de028aa}{getLang}(self, username, database): \textcolor{keyword}{pass}
00091 
00092     @property
\hypertarget{LoginUnit_8py_source_l00093}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a807b0a5d5bdae58087feb9d810a6538d}{00093}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a53b8075436052b94282021c84a2c3211}{pers}(self):
00094         \textcolor{keywordflow}{return} self.\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_aac72212096e8ac4cbad65a63d1d93221}{\_\_pers}
00095 
00096     @pers.setter
\hypertarget{LoginUnit_8py_source_l00097}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a807b0a5d5bdae58087feb9d810a6538d}{00097}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a53b8075436052b94282021c84a2c3211}{pers}(self, pers):
00098         \textcolor{keywordflow}{if} isinstance(value, IfPersLogin):
00099             self.\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_aac72212096e8ac4cbad65a63d1d93221}{\_\_pers} = pers
00100         \textcolor{keywordflow}{else}:
00101             \textcolor{keywordflow}{raise} TypeError(\textcolor{stringliteral}{"Expected IfPersLogin instance at \(\backslash\)}
00102 \textcolor{stringliteral}{                BusLogin.\_\_pers. Received "} + str(type(value)) + \textcolor{stringliteral}{"instead."})
00103 
00104     \textcolor{comment}{## Método de deleção do objeto que representa a camada de persistência.}
00105     @pers.deleter
\hypertarget{LoginUnit_8py_source_l00106}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a807b0a5d5bdae58087feb9d810a6538d}{00106}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a53b8075436052b94282021c84a2c3211}{pers}(self):
00107         del self.\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_aac72212096e8ac4cbad65a63d1d93221}{\_\_pers}
00108 
00109     \textcolor{comment}{## Força a criação da camada subjacente.}
\hypertarget{LoginUnit_8py_source_l00110}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a974c8e8520b02844836d9c7a8e06379b}{00110}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a974c8e8520b02844836d9c7a8e06379b}{\_\_init\_\_}(self, value):
00111         \textcolor{keywordflow}{try}:
\hypertarget{LoginUnit_8py_source_l00112}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a53b8075436052b94282021c84a2c3211}{00112}             self.\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a53b8075436052b94282021c84a2c3211}{pers} = value
00113         \textcolor{keywordflow}{except} TypeError \textcolor{keyword}{as} exc:
00114             del self
00115             \textcolor{keywordflow}{raise} exc
00116 
00117 
00118 \textcolor{comment}{## Interface para a camada de persistência do módulo de Login.}
00119 \textcolor{comment}{#   Deve ser capaz de capturar os dados necessários do banco de dados.}
\hypertarget{LoginUnit_8py_source_l00120}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfPersLogin}{00120} \textcolor{keyword}{class }\hyperlink{classLogin_1_1LoginUnit_1_1IfPersLogin}{IfPersLogin}:
00121 
00122     \_\_metaclass\_\_ = ABCMeta
00123 
00124     \textcolor{comment}{## Retorna um dicionário no formato de objeto com os dados do usuário}
00125     \textcolor{comment}{#   requisitado.}
00126     @abstractmethod
\hypertarget{LoginUnit_8py_source_l00127}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfPersLogin_a24648e1c42d0762277b5b7aa641fa575}{00127}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfPersLogin_a24648e1c42d0762277b5b7aa641fa575}{select}(self, username, database): \textcolor{keyword}{pass}
00128 
00129 
00130 \textcolor{comment}{## Camada de interface de usuário para o módulo de Login.}
\hypertarget{LoginUnit_8py_source_l00131}{}\hyperlink{classLogin_1_1LoginUnit_1_1UiLogin}{00131} \textcolor{keyword}{class }\hyperlink{classLogin_1_1LoginUnit_1_1UiLogin}{UiLogin}(\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin}{IfUiLogin}):
00132 
00133     \textcolor{comment}{## Método que inicia o módulo de login. }
00134     \textcolor{comment}{#   Aqui, ocorre a validação de formulário, autenticação de usuário, e}
00135     \textcolor{comment}{#   redirecionamento para a página de perfil.}
\hypertarget{LoginUnit_8py_source_l00136}{}\hyperlink{classLogin_1_1LoginUnit_1_1UiLogin_a9cd61a78d5ab0d201051ccf5898f86bc}{00136}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1UiLogin_a9cd61a78d5ab0d201051ccf5898f86bc}{run}(self, request, database):
00137         \textcolor{keywordflow}{if} request.method == \textcolor{stringliteral}{"POST"}:
00138             login\_form = \hyperlink{classLogin_1_1forms_1_1LoginForm}{LoginForm}(request.POST)
00139             \textcolor{keywordflow}{try}: 
00140                 \textcolor{keywordflow}{if} login\_form.is\_valid():
00141                     self.bus.validate(login\_form.cleaned\_data[\textcolor{stringliteral}{'username'}],
00142                         login\_form.cleaned\_data[\textcolor{stringliteral}{'password'}], database)
00143                 \textcolor{keywordflow}{else}:
00144                     \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_INV\_LOG'}])
00145             \textcolor{keywordflow}{except} ValueError \textcolor{keyword}{as} exc:
00146                 \textcolor{keywordflow}{if} database.\_\_name\_\_ == \textcolor{stringliteral}{"Professor"}:
00147                     target = \textcolor{stringliteral}{"proflogin"}
00148                 \textcolor{keywordflow}{elif} database.\_\_name\_\_ == \textcolor{stringliteral}{"Adm"}:
00149                     target = \textcolor{stringliteral}{"364fd8cdc3a35a89b7be75bc9d10ebea"}
00150                 \textcolor{keywordflow}{else}:
00151                     target = \textcolor{stringliteral}{""}
00152 
00153                 \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Login/form.html"}, \{\textcolor{stringliteral}{'form'}: login\_form, 
00154                     \textcolor{stringliteral}{'error'}: exc, \textcolor{stringliteral}{'target'}: target\})
00155             \textcolor{keywordflow}{else}:
00156                 cd = login\_form.cleaned\_data
00157                 l = self.bus.getLang(cd[\textcolor{stringliteral}{'username'}], database)
00158                 request.session[\textcolor{stringliteral}{'user'}] = \{
00159                                 \textcolor{stringliteral}{'name'}: cd[\textcolor{stringliteral}{'username'}].value,
00160                                 \textcolor{stringliteral}{'password'}: cd[\textcolor{stringliteral}{'password'}].value,
00161                                 \textcolor{stringliteral}{'language'}: l ,
00162                                 \textcolor{stringliteral}{'type'}: database.\_\_name\_\_,
00163                             \}
00164                 \textcolor{keywordflow}{return} HttpResponseRedirect(\textcolor{stringliteral}{'/'})
00165         \textcolor{keywordflow}{else}:
00166             login\_form = \hyperlink{classLogin_1_1forms_1_1LoginForm}{LoginForm}()
00167 
00168             \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} database:
00169                 target = \textcolor{stringliteral}{""}
00170             \textcolor{keywordflow}{if} database.\_\_name\_\_ == \textcolor{stringliteral}{"Professor"}:
00171                 target = \textcolor{stringliteral}{"proflogin"}
00172             \textcolor{keywordflow}{elif} database.\_\_name\_\_ == \textcolor{stringliteral}{"Adm"}:
00173                 target = \textcolor{stringliteral}{"364fd8cdc3a35a89b7be75bc9d10ebea"}
00174             \textcolor{keywordflow}{else}:
00175                 target = \textcolor{stringliteral}{""}
00176 
00177             \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Login/form.html"}, \{\textcolor{stringliteral}{'form'}: login\_form, \textcolor{stringliteral}{'target'}: target\})
00178 
00179 
00180 \textcolor{comment}{## Camada de negócio de usuário para o módulo de Login.}
\hypertarget{LoginUnit_8py_source_l00181}{}\hyperlink{classLogin_1_1LoginUnit_1_1BusLogin}{00181} \textcolor{keyword}{class }\hyperlink{classLogin_1_1LoginUnit_1_1BusLogin}{BusLogin}(\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin}{IfBusLogin}):
00182 
\hypertarget{LoginUnit_8py_source_l00183}{}\hyperlink{classLogin_1_1LoginUnit_1_1BusLogin_a2301425767b811697ce559801b955a58}{00183}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1BusLogin_a2301425767b811697ce559801b955a58}{validate}(self, username, password, database):
00184         upass = self.pers.select(username.value, database)
00185         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} upass \textcolor{keywordflow}{or} upass[\textcolor{stringliteral}{'password'}] != password.value:
00186             \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_INV\_LOG'}])
00187 
\hypertarget{LoginUnit_8py_source_l00188}{}\hyperlink{classLogin_1_1LoginUnit_1_1BusLogin_a23223ddd567bf874e6230efaf4912e98}{00188}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1BusLogin_a23223ddd567bf874e6230efaf4912e98}{getLang}(self, username, database):
00189         ulang = self.pers.select(username.value, database)
00190         \textcolor{keywordflow}{return} ulang[\textcolor{stringliteral}{'language'}]
00191 
00192 \textcolor{comment}{## Camada de persistência de usuário para o módulo de Login.}
\hypertarget{LoginUnit_8py_source_l00193}{}\hyperlink{classLogin_1_1LoginUnit_1_1PersLogin}{00193} \textcolor{keyword}{class }\hyperlink{classLogin_1_1LoginUnit_1_1PersLogin}{PersLogin}(\hyperlink{classLogin_1_1LoginUnit_1_1IfPersLogin}{IfPersLogin}):
00194 
\hypertarget{LoginUnit_8py_source_l00195}{}\hyperlink{classLogin_1_1LoginUnit_1_1PersLogin_a1847dbd744377283add2327d2eb0b99f}{00195}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1PersLogin_a1847dbd744377283add2327d2eb0b99f}{select}(self, username=None, database=None):
00196         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} username: \textcolor{keywordflow}{return} \textcolor{keyword}{False}
00197         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} database: \textcolor{keywordflow}{return} \textcolor{keyword}{False}
00198 
00199         ulang = \textcolor{keywordtype}{None}
00200 
00201         \textcolor{keywordflow}{try}:
00202             uid = database.objects.get(value=username, field=\textcolor{stringliteral}{'NAME'}).identity
00203             upass = database.objects.get(identity=uid, field=\textcolor{stringliteral}{'PASSWORD'}).value
00204         \textcolor{keywordflow}{except} database.DoesNotExist:
00205             \textcolor{keywordflow}{return} \textcolor{keyword}{False}
00206 
00207         \textcolor{keywordflow}{if} isinstance(database, Student):
00208             \textcolor{keywordflow}{try}:
00209                 ulang = database.objects.get(identity=uid, field=\textcolor{stringliteral}{'LANGUAGE'}).value
00210             \textcolor{keywordflow}{except} database.DoesNotExist:
00211                 \textcolor{keywordflow}{pass}
00212         \textcolor{keywordflow}{else}:
00213             ulang = settings.LANGUAGE\_CODE
00214 
00215         \textcolor{keywordflow}{return} \{\textcolor{stringliteral}{'name'}: username, \textcolor{stringliteral}{'password'}: upass, \textcolor{stringliteral}{'language'}: ulang\}
\end{DoxyCode}
