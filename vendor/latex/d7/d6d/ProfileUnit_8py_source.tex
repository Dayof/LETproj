\hypertarget{ProfileUnit_8py}{\subsection{Profile\-Unit.\-py}
\label{ProfileUnit_8py}\index{E\-L\-O/\-Profile/\-Profile\-Unit.\-py@{E\-L\-O/\-Profile/\-Profile\-Unit.\-py}}
}

\begin{DoxyCode}
\hypertarget{ProfileUnit_8py_source_l00001}{}\hyperlink{namespaceProfile_1_1ProfileUnit}{00001} \textcolor{comment}{#coding: utf-8}
00002 
00003 \textcolor{comment}{## @file ProfileUnit.py}
00004 \textcolor{comment}{#   Este arquivo é responsável pelo armazenamento de todas as camadas }
00005 \textcolor{comment}{# correspondentes ao módulo de perfil. }
00006 \textcolor{comment}{#   O módulo de perfil é designado a administrar duas das páginas do site}
00007 \textcolor{comment}{# final: a página "home" e a página de perfil.}
00008 \textcolor{comment}{#   Na página Home, o usuário (Student ou Professor, Adms não possuem perfil)}
00009 \textcolor{comment}{# terá acesso a uma versão resumida do seu perfil, bem como um infográfico com}
00010 \textcolor{comment}{# o seu desenvolvimento nos cursos em que está cadastrado. É possível, a partir}
00011 \textcolor{comment}{# desta página, acessar a página de perfil e a página de curso (vide }
00012 \textcolor{comment}{# CourseUnit.py).}
00013 \textcolor{comment}{#   A página de perfil, por sua vez, disponibilizará ao usuário (quase) todas}
00014 \textcolor{comment}{# as informações que o sistema guarda sobre ele, e também o possibilitará }
00015 \textcolor{comment}{# editar alguns campos, como "interesses" ou "biografia".}
00016 \textcolor{comment}{# É nesta página que o usuário poderá alterar sua senha.}
00017 
00018 \textcolor{keyword}{from} abc \textcolor{keyword}{import} *
00019 
00020 \textcolor{keyword}{import} \hyperlink{namespaceELO_1_1locale_1_1index}{ELO.locale.index} \textcolor{keyword}{as} lang
00021 
00022 \textcolor{keyword}{from} \hyperlink{namespaceELO_1_1models}{ELO.models} \textcolor{keyword}{import} Student, Professor
00023 \textcolor{keyword}{from} \hyperlink{namespaceProfile_1_1forms}{Profile.forms} \textcolor{keyword}{import} (
00024     NameForm, 
00025     PasswordForm,
00026     LanguageForm,
00027     SexForm,
00028     BiosForm,
00029     InterestsForm,
00030     AvatarForm)
00031 
00032 \textcolor{keyword}{from} django.conf \textcolor{keyword}{import} settings
00033 \textcolor{keyword}{from} django.shortcuts \textcolor{keyword}{import} render
00034 \textcolor{keyword}{from} django.http \textcolor{keyword}{import} HttpResponseRedirect
00035 \textcolor{keyword}{from} django.utils \textcolor{keyword}{import} translation
00036 
00037 \textcolor{comment}{## Interface para a camada de Apresentação de Usuário do módulo Profile.}
00038 \textcolor{comment}{#   É responsável pelo carregamento do template correto e processa os }
00039 \textcolor{comment}{#   dados inseridos nos formulários de Perfil.}
\hypertarget{ProfileUnit_8py_source_l00040}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile}{00040} \textcolor{keyword}{class }\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile}{IfUiProfile}:
00041     \_\_metaclass\_\_ = ABCMeta
00042 
00043     \textcolor{comment}{## Força a criação da camada subjacente.}
\hypertarget{ProfileUnit_8py_source_l00044}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_a558fbb501ee3dbc4a16d3165479c38bc}{00044}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_a558fbb501ee3dbc4a16d3165479c38bc}{\_\_init\_\_}(self, bus):
00045         \textcolor{keywordflow}{try}:
\hypertarget{ProfileUnit_8py_source_l00046}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_a32a87d193e5d14e0ff3125d6bab2c420}{00046}             self.\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_a32a87d193e5d14e0ff3125d6bab2c420}{bus} = bus
00047         \textcolor{keywordflow}{except} TypeError \textcolor{keyword}{as} exc:
00048             del self
00049             \textcolor{keywordflow}{raise} exc
00050 
00051     @property
\hypertarget{ProfileUnit_8py_source_l00052}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_ac3d0a7a780dcf729b9f3cf1fff243a78}{00052}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_a32a87d193e5d14e0ff3125d6bab2c420}{bus}(self):
00053         \textcolor{keywordflow}{return} self.\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_af2171c776276848c2961f6fa818e0f67}{\_\_bus}
00054 
00055     @bus.setter
\hypertarget{ProfileUnit_8py_source_l00056}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_ac3d0a7a780dcf729b9f3cf1fff243a78}{00056}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_a32a87d193e5d14e0ff3125d6bab2c420}{bus}(self, value):
00057         \textcolor{keywordflow}{if} isinstance(value, IfBusProfile):
00058             self.\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_af2171c776276848c2961f6fa818e0f67}{\_\_bus} = value
00059         \textcolor{keywordflow}{else}:
00060             \textcolor{keywordflow}{raise} TypeError(\textcolor{stringliteral}{"Expected IfBusProfile instance at \(\backslash\)}
00061 \textcolor{stringliteral}{                UiProfile.\_\_bus. Received "} + 
00062                 str(type(value)) + \textcolor{stringliteral}{" instead."})
00063 
00064     @bus.deleter
\hypertarget{ProfileUnit_8py_source_l00065}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_ac3d0a7a780dcf729b9f3cf1fff243a78}{00065}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_a32a87d193e5d14e0ff3125d6bab2c420}{bus}(self):
00066         del self.\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_af2171c776276848c2961f6fa818e0f67}{\_\_bus}
00067 
00068     \textcolor{comment}{## 'Run' é o principal método de qualquer classe de apresentação. }
00069     \textcolor{comment}{#   Este método permite a Factory dar o controle do programa }
00070     \textcolor{comment}{#   módulo.}
00071     @abstractmethod
\hypertarget{ProfileUnit_8py_source_l00072}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_afb22574cb4a2dc58c068437bd7075e5a}{00072}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_afb22574cb4a2dc58c068437bd7075e5a}{run}(self, request): \textcolor{keyword}{pass}
00073 
00074 
00075 \textcolor{comment}{## Interface para a camada de Negócio do módulo de perfil.}
00076 \textcolor{comment}{#   É responsável por executar a atualização do Cookie de dados do}
00077 \textcolor{comment}{#   usuário, bem como a devida recuperação de dados para o sistema.}
\hypertarget{ProfileUnit_8py_source_l00078}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile}{00078} \textcolor{keyword}{class }\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile}{IfBusProfile}:
00079     \_\_metaclass\_\_ = ABCMeta
00080 
00081     \textcolor{comment}{## Força a criação das camadas subjacentes.}
\hypertarget{ProfileUnit_8py_source_l00082}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_a3c02bbff4cb54b40edab64d0f9b86a59}{00082}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_a3c02bbff4cb54b40edab64d0f9b86a59}{\_\_init\_\_}(self, pers):
00083         \textcolor{keywordflow}{try}:
\hypertarget{ProfileUnit_8py_source_l00084}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_abe265adaf3fd39d6534f9ad4c9ba8abb}{00084}             self.\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_abe265adaf3fd39d6534f9ad4c9ba8abb}{pers} = pers
00085         \textcolor{keywordflow}{except} TypeError \textcolor{keyword}{as} exc:
00086             del self
00087             \textcolor{keywordflow}{raise} exc
00088 
00089     @property
\hypertarget{ProfileUnit_8py_source_l00090}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_a996592f4b01e0540f45d042065d5a7f4}{00090}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_abe265adaf3fd39d6534f9ad4c9ba8abb}{pers}(self):
00091         \textcolor{keywordflow}{return} self.\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_ae752633c4645cd118c3c74e03a5fa7b5}{\_\_pers}
00092     
00093     @pers.setter
\hypertarget{ProfileUnit_8py_source_l00094}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_a996592f4b01e0540f45d042065d5a7f4}{00094}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_abe265adaf3fd39d6534f9ad4c9ba8abb}{pers}(self, value):
00095         \textcolor{keywordflow}{if} isinstance(value, IfPersProfile):
00096             self.\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_ae752633c4645cd118c3c74e03a5fa7b5}{\_\_pers} = value
00097         \textcolor{keywordflow}{else}:
00098             \textcolor{keywordflow}{raise} TypeError(\textcolor{stringliteral}{"Expected IfPersProfile instance at \(\backslash\)}
00099 \textcolor{stringliteral}{                BusProfile.\_\_pers. Received "} + 
00100                 str(type(value)) + \textcolor{stringliteral}{"instead."})
00101 
00102     @pers.deleter
\hypertarget{ProfileUnit_8py_source_l00103}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_a996592f4b01e0540f45d042065d5a7f4}{00103}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_abe265adaf3fd39d6534f9ad4c9ba8abb}{pers}(self):
00104         del self.\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_ae752633c4645cd118c3c74e03a5fa7b5}{\_\_pers}
00105 
00106     \textcolor{comment}{## Atualiza os dados de usuário no cookie de sessão.}
00107     @abstractmethod
\hypertarget{ProfileUnit_8py_source_l00108}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_abe42ebac800e9dcd762e9d73b4a5f9b8}{00108}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_abe42ebac800e9dcd762e9d73b4a5f9b8}{refreshUser}(self, request): \textcolor{keyword}{pass}
00109 
00110     \textcolor{comment}{## Edita um dos dados de usuário no cookie E no banco de dados.}
00111     \textcolor{comment}{#   Retorna o valor editado.}
00112     \textcolor{comment}{#}
00113     \textcolor{comment}{#   @arg field      Nome do campo que deve ser editado.}
00114     \textcolor{comment}{#}
00115     \textcolor{comment}{#   @arg form       Objeto form que contém os dados.}
00116     @abstractmethod
\hypertarget{ProfileUnit_8py_source_l00117}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_a1e1a9ec32d2c23c734eaf0ceb6bb8419}{00117}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile_a1e1a9ec32d2c23c734eaf0ceb6bb8419}{editField}(self, request, field, form): \textcolor{keyword}{pass}
00118 
00119 
00120 \textcolor{comment}{## Interface para a camada de Persistência do módulo de perfil.}
00121 \textcolor{comment}{#   É responsável pela manipulação dos dados do usuário logado do banco}
00122 \textcolor{comment}{#   de dados.}
\hypertarget{ProfileUnit_8py_source_l00123}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfPersProfile}{00123} \textcolor{keyword}{class }\hyperlink{classProfile_1_1ProfileUnit_1_1IfPersProfile}{IfPersProfile}:
00124     \_\_metaclass\_\_ = ABCMeta
00125 
00126     \textcolor{comment}{##  Função que recupera todos os dados do usuário.}
00127     \textcolor{comment}{#       Percorre o banco de dados e recupera todos os dados do usuário}
00128     \textcolor{comment}{#       requisitado.}
00129     \textcolor{comment}{#}
00130     \textcolor{comment}{#   @arg    username    Nome do usuário a ser pesquisado.}
00131     \textcolor{comment}{#}
00132     \textcolor{comment}{#   @arg    database    Objeto modelo sobre o qual a consulta será}
00133     \textcolor{comment}{#                       realizada.}
00134     @abstractmethod
\hypertarget{ProfileUnit_8py_source_l00135}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfPersProfile_a64821aed51d9e9d64f6da9ee9b20fdeb}{00135}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfPersProfile_a64821aed51d9e9d64f6da9ee9b20fdeb}{fetch}(self, username, database): \textcolor{keyword}{pass}
00136 
00137     \textcolor{comment}{##  Método que atualiza os dados de um usuário fornecido.}
00138     \textcolor{comment}{#       No caso de campos multivalorados, adiciona uma nova entrada.}
00139     \textcolor{comment}{#       Caso contrário, substitui a entrada anterior.}
00140     \textcolor{comment}{#}
00141     \textcolor{comment}{#   @arg    username    Nome do usuário sobre o qual a consulta será}
00142     \textcolor{comment}{#                       realizada.}
00143     \textcolor{comment}{#   @arg    field       Campo a ser atualizado.}
00144     \textcolor{comment}{#}
00145     \textcolor{comment}{#   @arg    newdata     Dado a ser atualizado.}
00146     \textcolor{comment}{#}
00147 
00148     \textcolor{comment}{#   @arg    database    Objeto de modelo que será utilizado.}
00149     @abstractmethod
\hypertarget{ProfileUnit_8py_source_l00150}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfPersProfile_ae2d65e1ead2780de7b97fab078bb425e}{00150}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfPersProfile_ae2d65e1ead2780de7b97fab078bb425e}{update}(self, username, field, newdata, database): \textcolor{keyword}{pass}
00151 
00152 
00153     \textcolor{comment}{## Método que recupera os dados de um campo específico de todos.}
00154     \textcolor{comment}{#       Atualmente, não está sendo utilizado para nada, mas numa versão}
00155     \textcolor{comment}{#       anterior do software, era capaz de recuperar os interesses dos}
00156     \textcolor{comment}{#       usuários para listá-los e agrupá-los.}
00157     \textcolor{comment}{#}
00158     \textcolor{comment}{#   @arg    field       Campo a ser pesquisado.}
\hypertarget{ProfileUnit_8py_source_l00159}{}\hyperlink{classProfile_1_1ProfileUnit_1_1IfPersProfile_aaa886f8741f0b2ca562968cf9a688aa7}{00159}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1IfPersProfile_aaa886f8741f0b2ca562968cf9a688aa7}{fetchField}(self, field): \textcolor{keyword}{pass}
00160 
00161 \textcolor{comment}{## Camada de apresentação para a página principal do site.}
00162 \textcolor{comment}{#   Deve carregar o devido template, contendo os dados básicos do usuário,}
00163 \textcolor{comment}{#   como cursos matriculados e histórico para estudantes, e cursos monitorados}
00164 \textcolor{comment}{#   para professores.}
\hypertarget{ProfileUnit_8py_source_l00165}{}\hyperlink{classProfile_1_1ProfileUnit_1_1UiHomeProfile}{00165} \textcolor{keyword}{class }\hyperlink{classProfile_1_1ProfileUnit_1_1UiHomeProfile}{UiHomeProfile}(\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile}{IfUiProfile}): 
00166 
\hypertarget{ProfileUnit_8py_source_l00167}{}\hyperlink{classProfile_1_1ProfileUnit_1_1UiHomeProfile_a5abc7f7c1ca1cb3e070c36a869263e6d}{00167}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1UiHomeProfile_a5abc7f7c1ca1cb3e070c36a869263e6d}{run}(self, request):
00168         user = request.session[\textcolor{stringliteral}{'user'}]
00169         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} \textcolor{stringliteral}{'matric'} \textcolor{keywordflow}{in} user:
00170             request.session[\textcolor{stringliteral}{'user'}] = self.bus.refreshUser(request)
00171             user = request.session[\textcolor{stringliteral}{'user'}]
00172         \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Profile/home.html"}, \{\textcolor{stringliteral}{'user'} : user\})
00173 
00174 \textcolor{comment}{## Camada de apresentação para a página de perfil completa.}
00175 \textcolor{comment}{#   Deve ser capaz de gerar uma página que disponibilize os dados}
00176 \textcolor{comment}{#   do usuário, permitindo que ele edite ou não, alguns campos.}
00177 \textcolor{comment}{#   Caso a run() seja chamada com um argumento adicional field,}
00178 \textcolor{comment}{#   a chamada será considerada assíncrona, assim como no caso do}
00179 \textcolor{comment}{#   request.method ser POST.}
\hypertarget{ProfileUnit_8py_source_l00180}{}\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile}{00180} \textcolor{keyword}{class }\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile}{UiFullProfile}(\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile}{IfUiProfile}):
00181 
00182     \textcolor{comment}{## Lista de campos passíveis de edição por um usuário.}
00183     \_\_editable = [
00184                     \textcolor{stringliteral}{'name'},
00185                     \textcolor{stringliteral}{'password'},
00186                     \textcolor{stringliteral}{'sex'},
00187                     \textcolor{stringliteral}{'bios'},
00188                     \textcolor{stringliteral}{'avatar'}
00189                     ]
00190 
00191     \_\_editable\_stu = [
00192                     \textcolor{stringliteral}{'language'},
00193                     \textcolor{stringliteral}{'interests'}
00194                     ]
00195 
00196     \_\_viewable = [
00197                     \textcolor{stringliteral}{'email'},
00198                     \textcolor{stringliteral}{'campus'},
00199                     \textcolor{stringliteral}{'matric'}
00200                     ]
00201 
\hypertarget{ProfileUnit_8py_source_l00202}{}\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_ae9ec0c6554ceb52fd45d48dda2ea4218}{00202}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_ae9ec0c6554ceb52fd45d48dda2ea4218}{\_\_init\_\_}(self, bus):
00203         self.\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_a92a8fe9852ca9a15af9f0b3b1f7f3475}{\_\_viewable} += self.\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_ad83bd84ca790c9c849a29ff074848bd4}{\_\_editable}
00204         \textcolor{keywordflow}{try}:
\hypertarget{ProfileUnit_8py_source_l00205}{}\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_a47049f3f61c7fada93dd84fccd19a2bd}{00205}             self.\hyperlink{classProfile_1_1ProfileUnit_1_1IfUiProfile_a32a87d193e5d14e0ff3125d6bab2c420}{bus} = bus
00206         \textcolor{keywordflow}{except} TypeError \textcolor{keyword}{as} exc:
00207             del self
00208             \textcolor{keywordflow}{raise} exc
00209 
00210     \textcolor{comment}{##  Capaz de criar um template-iterable array com os dados de usuario.}
00211     \textcolor{keyword}{def }\_\_makeData(self, user):
00212         data = \{\}
00213 
00214         \textcolor{keywordflow}{if} user[\textcolor{stringliteral}{"type"}] == \textcolor{stringliteral}{"Student"}:
00215             self.\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_a92a8fe9852ca9a15af9f0b3b1f7f3475}{\_\_viewable} += self.\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_ac0498ee9df8afbed7dd944fe293b6c44}{\_\_editable\_stu}
00216             \_\_ed = self.\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_ad83bd84ca790c9c849a29ff074848bd4}{\_\_editable} + self.\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_ac0498ee9df8afbed7dd944fe293b6c44}{\_\_editable\_stu}
00217         \textcolor{keywordflow}{else}:
00218             \_\_ed = self.\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_ad83bd84ca790c9c849a29ff074848bd4}{\_\_editable}
00219 
00220         \textcolor{keywordflow}{for} field, value \textcolor{keywordflow}{in} user.items():
00221             \textcolor{keywordflow}{if} field \textcolor{keywordflow}{in} self.\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_a92a8fe9852ca9a15af9f0b3b1f7f3475}{\_\_viewable}:
00222                 data[field] = \{
00223                     \textcolor{stringliteral}{"value"}: value,
00224                     \textcolor{stringliteral}{"edit"}:\textcolor{keyword}{True} \textcolor{keywordflow}{if} field \textcolor{keywordflow}{in} \_\_ed \textcolor{keywordflow}{else} \textcolor{keyword}{False},
00225                     \textcolor{stringliteral}{"mult"}:\textcolor{keyword}{True} \textcolor{keywordflow}{if} isinstance(value, list)  \textcolor{keywordflow}{else} \textcolor{keyword}{False},
00226                     \textcolor{stringliteral}{"fname"}: lang.DICT[field.upper()],
00227                             \}
00228 
00229         \textcolor{keywordflow}{return} data
00230 
\hypertarget{ProfileUnit_8py_source_l00231}{}\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_a7a7747246b627020a345f7a3eac27778}{00231}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_a7a7747246b627020a345f7a3eac27778}{run}(self, request, field=None):
00232 
00233         get\_user = \textcolor{keyword}{lambda}: request.session[\textcolor{stringliteral}{'user'}]
00234 
00235         \textcolor{comment}{## @if Verifica qual o propósito do submit.}
00236         \textcolor{comment}{#   Caso seja POST, a requisição ocorre após a submissão de uma form,}
00237         \textcolor{comment}{#       muito provavelmente da form de edição de campo.}
00238         \textcolor{comment}{#   Caso não seja, a requisição há de ser um GET, para mostrar as}
00239         \textcolor{comment}{#       opções de edição.}
00240         \textcolor{keywordflow}{if} request.method == \textcolor{stringliteral}{"POST"}:
00241 
00242             \textcolor{keywordflow}{try}:
00243                 \textcolor{keywordflow}{if}   \textcolor{stringliteral}{"name"} \textcolor{keywordflow}{in} request.POST:
00244                     form = NameForm(request.POST)
00245                     field = \textcolor{stringliteral}{"name"}
00246                 \textcolor{keywordflow}{if}  \textcolor{stringliteral}{"password"} \textcolor{keywordflow}{in} request.POST:
00247                     form = PasswordForm(request.POST)
00248                     field = \textcolor{stringliteral}{"password"}
00249                 \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"language"} \textcolor{keywordflow}{in} request.POST:
00250                     form = LanguageForm(request.POST)
00251                     field = \textcolor{stringliteral}{"language"}
00252                 \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"sex"} \textcolor{keywordflow}{in} request.POST:
00253                     form = SexForm(request.POST)
00254                     field = \textcolor{stringliteral}{"sex"}
00255                 \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"bios"} \textcolor{keywordflow}{in} request.POST:
00256                     form = BiosForm(request.POST)
00257                     field = \textcolor{stringliteral}{"bios"}
00258                 \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"interests"} \textcolor{keywordflow}{in} request.POST:
00259                     form = InterestsForm(request.POST)
00260                     field = \textcolor{stringliteral}{"interests"}
00261                 \textcolor{keywordflow}{elif} \textcolor{stringliteral}{"avatar"} \textcolor{keywordflow}{in} request.POST:
00262                     form = AvatarForm(request.POST, request.FILES)
00263                     field = \textcolor{stringliteral}{"avatar"}
00264                 \textcolor{keywordflow}{else}:
00265                     \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_INV\_FRM'}])
00266 
00267                 \textcolor{keywordflow}{if} form.is\_valid():
00268                     request.session[\textcolor{stringliteral}{'user'}][field] = self.bus.editField(
00269                                                         request, 
00270                                                         field, 
00271                                                         form )
00272                     request.session.modified = \textcolor{keyword}{True}
00273                 \textcolor{keywordflow}{else}:
00274                     \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_INV\_FRM'}] + 
00275                         \textcolor{stringliteral}{":"} + form.errors)
00276 
00277             \textcolor{keywordflow}{except} ValueError \textcolor{keyword}{as} exc:
00278                 data = self.\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_ae0e9c54df37ab45f0d1c5d894181d10f}{\_\_makeData}(get\_user())
00279                 \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Profile/full.html"}, \{\textcolor{stringliteral}{'data'} : data,
00280                                                              \textcolor{stringliteral}{'error'}: exc \})
00281 
00282             data = self.\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_ae0e9c54df37ab45f0d1c5d894181d10f}{\_\_makeData}(get\_user())
00283             \textcolor{keywordflow}{return} HttpResponseRedirect(\textcolor{stringliteral}{'/profile'})
00284 
00285         \textcolor{keywordflow}{else}: \textcolor{comment}{# request.method == "GET"}
00286             \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} field: \textcolor{comment}{# normal call}
00287                 request.session[\textcolor{stringliteral}{'user'}] = self.bus.refreshUser(request)
00288                 data = self.\hyperlink{classProfile_1_1ProfileUnit_1_1UiFullProfile_ae0e9c54df37ab45f0d1c5d894181d10f}{\_\_makeData}(get\_user())
00289                 l = request.session[\textcolor{stringliteral}{'user'}][\textcolor{stringliteral}{'language'}]
00290                 translation.activate(l)
00291                 request.session[translation.LANGUAGE\_SESSION\_KEY] = l
00292                 \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Profile/full.html"}, \{\textcolor{stringliteral}{'data'} : data\})
00293             \textcolor{keywordflow}{else}: \textcolor{comment}{# ajax call}
00294                 err = \textcolor{keyword}{False}
00295                 \textcolor{keywordflow}{if}   field == \textcolor{stringliteral}{"name"}:
00296                     form = NameForm(initial=\{\textcolor{stringliteral}{'newdata'}:get\_user()[\textcolor{stringliteral}{'name'}]\})
00297                 \textcolor{keywordflow}{elif} field == \textcolor{stringliteral}{"password"}:
00298                     form = PasswordForm()
00299                 \textcolor{keywordflow}{elif} field == \textcolor{stringliteral}{"language"}:
00300                     form = LanguageForm(initial=\{
00301                             \textcolor{stringliteral}{'newdata'}:get\_user()[\textcolor{stringliteral}{'language'}]\})
00302                 \textcolor{keywordflow}{elif} field == \textcolor{stringliteral}{"sex"}:
00303                     form = SexForm(initial=\{\textcolor{stringliteral}{'newdata'}:get\_user()[\textcolor{stringliteral}{'sex'}]\})
00304                 \textcolor{keywordflow}{elif} field == \textcolor{stringliteral}{"bios"}:
00305                     form = BiosForm(initial=\{\textcolor{stringliteral}{'newdata'}:get\_user()[\textcolor{stringliteral}{'bios'}]\})
00306                 \textcolor{keywordflow}{elif} field == \textcolor{stringliteral}{"interests"}:
00307                     form = InterestsForm(initial=\{
00308                             \textcolor{stringliteral}{'newdata'}:get\_user()[\textcolor{stringliteral}{'interests'}]\})
00309                 \textcolor{keywordflow}{elif} field == \textcolor{stringliteral}{"avatar"}:
00310                     form = AvatarForm()
00311                 \textcolor{keywordflow}{else}:
00312                     form = lang.DICT[\textcolor{stringliteral}{"ERROR\_FORM"}]
00313                     err = \textcolor{keyword}{True} 
00314 
00315                 \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Profile/edit.html"}, \{\textcolor{stringliteral}{'form'}: form,
00316                                                              \textcolor{stringliteral}{'ff'}: field,
00317                                                              \textcolor{stringliteral}{'err'}: err,
00318                                                             \})
00319         
00320 
00321 \textcolor{comment}{## Camada de negócio para perfil.}
00322 \textcolor{comment}{#   Deve ser capaz de manipular os dados de usuário, seja no sentido de }
00323 \textcolor{comment}{#   atualizá-los ou modificá-los de alguma forma.}
\hypertarget{ProfileUnit_8py_source_l00324}{}\hyperlink{classProfile_1_1ProfileUnit_1_1BusProfile}{00324} \textcolor{keyword}{class }\hyperlink{classProfile_1_1ProfileUnit_1_1BusProfile}{BusProfile}(\hyperlink{classProfile_1_1ProfileUnit_1_1IfBusProfile}{IfBusProfile}):
00325 
\hypertarget{ProfileUnit_8py_source_l00326}{}\hyperlink{classProfile_1_1ProfileUnit_1_1BusProfile_a87c3d0374f709af7904656938eafd6d3}{00326}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1BusProfile_a87c3d0374f709af7904656938eafd6d3}{refreshUser}(self, request):
00327         user = request.session[\textcolor{stringliteral}{'user'}]
00328         db = \textcolor{keywordtype}{None}
00329 
00330         \textcolor{keywordflow}{if} user[\textcolor{stringliteral}{'type'}] == \textcolor{stringliteral}{'Student'}:
00331             db = Student
00332         \textcolor{keywordflow}{elif} user[\textcolor{stringliteral}{'type'}] == \textcolor{stringliteral}{'Professor'}:
00333             db = Professor
00334 
00335         fs = self.pers.fetch(user[\textcolor{stringliteral}{'name'}], db)
00336         fd = dict(fs)
00337         request.session[\textcolor{stringliteral}{'django\_language'}] = fd[\textcolor{stringliteral}{'language'}]
00338         \textcolor{keywordflow}{return} dict(user.items()+ self.pers.fetch(user[\textcolor{stringliteral}{'name'}], db))
00339 
\hypertarget{ProfileUnit_8py_source_l00340}{}\hyperlink{classProfile_1_1ProfileUnit_1_1BusProfile_a5c116d007081ffefcc1c45cd34c88e10}{00340}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1BusProfile_a5c116d007081ffefcc1c45cd34c88e10}{editField}(self, request, field, form):
00341         user = request.session[\textcolor{stringliteral}{'user'}]
00342         \textcolor{keywordflow}{if} field == \textcolor{stringliteral}{"name"}:
00343             fpw = form.cleaned\_data[\textcolor{stringliteral}{'password'}].value
00344             \textcolor{keywordflow}{if} fpw != user[\textcolor{stringliteral}{'password'}]:
00345                 \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_INV\_PW\_F'}])
00346             newdata = form.cleaned\_data[\textcolor{stringliteral}{'newdata'}].value
00347         \textcolor{keywordflow}{elif} field == \textcolor{stringliteral}{"password"}:
00348             npw = form.cleaned\_data[\textcolor{stringliteral}{'newdata'}].value
00349             rpw = form.cleaned\_data[\textcolor{stringliteral}{'rp\_newdata'}].value
00350             opw = form.cleaned\_data[\textcolor{stringliteral}{'old\_password'}].value
00351             \textcolor{keywordflow}{if} npw != rpw:
00352                 \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_INV\_PW\_R'}])
00353             \textcolor{keywordflow}{if} opw != user[\textcolor{stringliteral}{'password'}]:
00354                 \textcolor{keywordflow}{raise} ValueError(lang.DICt[\textcolor{stringliteral}{'EXCEPTION\_INV\_PW\_F'}])
00355             newdata = npw
00356         \textcolor{keywordflow}{elif} field == \textcolor{stringliteral}{"language"}:
00357             newdata = form.cleaned\_data[\textcolor{stringliteral}{'newdata'}]
00358         \textcolor{keywordflow}{elif} field == \textcolor{stringliteral}{"avatar"}:
00359             addr = settings.MEDIA\_ROOT + \textcolor{stringliteral}{u"/"} + user[\textcolor{stringliteral}{'avatar'}]
00360             with open(addr, \textcolor{stringliteral}{"wb"}) \textcolor{keyword}{as} destination:
00361                     \textcolor{keywordflow}{for} chunk \textcolor{keywordflow}{in} request.FILES[\textcolor{stringliteral}{'newdata'}].chunks():
00362                         destination.write(chunk)
00363         \textcolor{keywordflow}{else}:
00364             newdata = form.cleaned\_data[\textcolor{stringliteral}{'newdata'}].value
00365 
00366         \textcolor{keywordflow}{try}:
00367             \textcolor{keywordflow}{if} user[\textcolor{stringliteral}{'type'}] == \textcolor{stringliteral}{'Student'} \textcolor{keywordflow}{and} field != \textcolor{stringliteral}{'avatar'}:
00368                 self.pers.update(user[\textcolor{stringliteral}{'name'}], field, newdata, Student)
00369             \textcolor{keywordflow}{elif} user[\textcolor{stringliteral}{'type'}] == \textcolor{stringliteral}{'Professor'} \textcolor{keywordflow}{and} field != \textcolor{stringliteral}{'avatar'}:
00370                 self.pers.update(user[\textcolor{stringliteral}{'name'}], field, newdata, Professor)
00371         \textcolor{keywordflow}{except} ValueError \textcolor{keyword}{as} exc:
00372             \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_ERR\_DB\_U'}])
00373         \textcolor{keywordflow}{else}:
00374             \textcolor{keywordflow}{if} field == \textcolor{stringliteral}{"language"}:
00375                 request.session[\textcolor{stringliteral}{'django\_language'}] = newdata
00376         \textcolor{keywordflow}{if} field == \textcolor{stringliteral}{'avatar'}:
00377             \textcolor{keywordflow}{return} user[\textcolor{stringliteral}{'avatar'}]
00378         \textcolor{keywordflow}{else}:
00379             \textcolor{keywordflow}{return} newdata
00380 
00381 \textcolor{comment}{## Camada de persistência de perfil.}
00382 \textcolor{comment}{#   Recupera os dados do usuário logado, retornando-os para a camada}
00383 \textcolor{comment}{#   de negócio.}
\hypertarget{ProfileUnit_8py_source_l00384}{}\hyperlink{classProfile_1_1ProfileUnit_1_1PersProfile}{00384} \textcolor{keyword}{class }\hyperlink{classProfile_1_1ProfileUnit_1_1PersProfile}{PersProfile}(\hyperlink{classProfile_1_1ProfileUnit_1_1IfPersProfile}{IfPersProfile}):
00385 
00386     \textcolor{keyword}{def }\_\_select\_field(self, uid, field, database):
00387 
00388         \textcolor{keywordflow}{try}:
00389             ret = database.objects.get(identity=uid, field=field)
00390             ret = ret.value
00391 
00392         \textcolor{keywordflow}{except} database.MultipleObjectsReturned:
00393             ret = map(\textcolor{keyword}{lambda} x: x.value, database.objects.filter(
00394                     identity=uid, field=field))
00395 
00396         \textcolor{keywordflow}{except} database.DoesNotExist:
00397             ret = \textcolor{keywordtype}{None} 
00398 
00399         \textcolor{keywordflow}{return} ret
00400 
\hypertarget{ProfileUnit_8py_source_l00401}{}\hyperlink{classProfile_1_1ProfileUnit_1_1PersProfile_aca301abc09bc12a7cf0a61437f941a8a}{00401}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1PersProfile_aca301abc09bc12a7cf0a61437f941a8a}{fetch}(self, username, database):
00402 
00403         \textcolor{keywordflow}{try}:
00404             uid = database.objects.get(field=\textcolor{stringliteral}{'NAME'},value=username)
00405             uid = uid.identity
00406 
00407             sf = \textcolor{keyword}{lambda} x: self.\hyperlink{classProfile_1_1ProfileUnit_1_1PersProfile_a48bc2c04d89772752559fc19dc79f321}{\_\_select\_field}(uid, x, database)
00408 
00409             fetchset = [
00410                     (\textcolor{stringliteral}{'password'},    sf(\textcolor{stringliteral}{'PASSWORD'})),
00411                     (\textcolor{stringliteral}{'matric'},      sf(\textcolor{stringliteral}{'MATRIC'})),
00412                     (\textcolor{stringliteral}{'bios'},        sf(\textcolor{stringliteral}{'BIOS'})),
00413                     (\textcolor{stringliteral}{'campus'},      sf(\textcolor{stringliteral}{'CAMPUS'})),
00414                     (\textcolor{stringliteral}{'courses'},     sf(\textcolor{stringliteral}{'COURSE'})),
00415                     (\textcolor{stringliteral}{'avatar'},      sf(\textcolor{stringliteral}{'AVATAR'})),
00416                     (\textcolor{stringliteral}{'email'},       sf(\textcolor{stringliteral}{'EMAIL'})),
00417                     (\textcolor{stringliteral}{'sex'},         sf(\textcolor{stringliteral}{'SEX'})),
00418             ]
00419 
00420             \textcolor{keywordflow}{if} database \textcolor{keywordflow}{is} Student:
00421                 fetchset = fetchset + [     
00422                     (\textcolor{stringliteral}{'grades'},      sf(\textcolor{stringliteral}{'GRADE'})),
00423                     (\textcolor{stringliteral}{'interests'},   sf(\textcolor{stringliteral}{'INTEREST'})),
00424                     (\textcolor{stringliteral}{'language'},    sf(\textcolor{stringliteral}{'LANGUAGE'})),
00425                 ]
00426 
00427         \textcolor{keywordflow}{except} database.DoesNotExist \textcolor{keyword}{as} exc:
00428             fetchset = []
00429 
00430         \textcolor{keywordflow}{return} fetchset
00431 
\hypertarget{ProfileUnit_8py_source_l00432}{}\hyperlink{classProfile_1_1ProfileUnit_1_1PersProfile_a68ab67bed74c46b72216e256af8f6711}{00432}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1PersProfile_a68ab67bed74c46b72216e256af8f6711}{fetchField}(self, field):
00433 
00434         ret = []
00435 
00436         \textcolor{keywordflow}{try}:
00437             lstu = Student.objects.filter(field=field)   \textcolor{comment}{#list of students}
00438             lpro = Professor.objects.filter(field=field) \textcolor{comment}{#list of professors }
00439 
00440         \textcolor{keywordflow}{except} Student.DoesNotExist:
00441             lstu = []
00442         \textcolor{keywordflow}{except} Professor.DoesNotExist:
00443             lpro = []
00444 
00445         \textcolor{keywordflow}{for} s \textcolor{keywordflow}{in} lstu:
00446             ret.append(s.value)
00447 
00448         \textcolor{keywordflow}{for} p \textcolor{keywordflow}{in} lpro:
00449             ret.append(p.value)
00450 
00451         \textcolor{keywordflow}{return} ret
00452 
\hypertarget{ProfileUnit_8py_source_l00453}{}\hyperlink{classProfile_1_1ProfileUnit_1_1PersProfile_af1e4b3cf0eee0a14b5113210503ff665}{00453}     \textcolor{keyword}{def }\hyperlink{classProfile_1_1ProfileUnit_1_1PersProfile_af1e4b3cf0eee0a14b5113210503ff665}{update}(self, username, field, newdata, database):
00454         
00455         \textcolor{keywordflow}{try}:
00456             uid = database.objects.get(field=\textcolor{stringliteral}{'NAME'}, value=username)
00457             uid = uid.identity
00458 
00459             \textcolor{comment}{## Para o caso de COURSEs, GRADEs ou INTERESTs.}
00460             \textcolor{keywordflow}{if} field[-1] == \textcolor{stringliteral}{'s'}:
00461                 \textcolor{keywordflow}{if} field[-2] == \textcolor{stringliteral}{'e'} \textcolor{keywordflow}{or} field[-2] == \textcolor{stringliteral}{'t'}:
00462                     field = field[:-1]
00463                 
00464             \textcolor{keywordflow}{try}:
00465                 data = database.objects.get(field=field.upper(), identity=uid)
00466                 data.value = newdata
00467             \textcolor{keywordflow}{except} database.DoesNotExist:
00468                 data = database(identity=uid, field=field.upper(), value=newdata)
00469             data.save()
00470 
00471         \textcolor{keywordflow}{except} ( database.DoesNotExist, 
00472                  database.MultipleObjectsReturned ) \textcolor{keyword}{as} exc:
00473             \textcolor{keywordflow}{raise} ValueError(exc)
\end{DoxyCode}
