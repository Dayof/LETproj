\hypertarget{LoginUnit_8py}{\subsection{Login\-Unit.\-py}
\label{LoginUnit_8py}\index{E\-L\-O/\-Login/\-Login\-Unit.\-py@{E\-L\-O/\-Login/\-Login\-Unit.\-py}}
}

\begin{DoxyCode}
\hypertarget{LoginUnit_8py_source_l00001}{}\hyperlink{namespaceLogin_1_1LoginUnit}{00001} \textcolor{comment}{#coding: utf-8}
00002 
00003 \textcolor{comment}{## @file Armazenamento de todas as camadas correspondentes ao módulo de login.}
00004 \textcolor{comment}{#   Os métodos aqui são criados e chamados pela Factory (MainUnit.py) quando}
00005 \textcolor{comment}{#   necessários.}
00006 \textcolor{comment}{#   Eles são responsáveis pela criação, gestão e deleção do objeto de sessão e }
00007 \textcolor{comment}{#   validação e login dos usuários.}
00008 
00009 \textcolor{keyword}{from} abc \textcolor{keyword}{import} *
00010 
00011 \textcolor{keyword}{from} django.shortcuts \textcolor{keyword}{import} render
00012 \textcolor{keyword}{from} django.http \textcolor{keyword}{import} HttpResponseRedirect
00013 \textcolor{keyword}{from} django.template \textcolor{keyword}{import} Template, Context
00014 \textcolor{keyword}{from} django \textcolor{keyword}{import} forms
00015 
00016 \textcolor{keyword}{from} \hyperlink{namespaceELO_1_1models}{ELO.models} \textcolor{keyword}{import} Student, Adm, Professor
00017 \textcolor{keyword}{from} \hyperlink{namespaceELO_1_1BaseUnit}{ELO.BaseUnit} \textcolor{keyword}{import} Name, Password
00018 \textcolor{keyword}{from} \hyperlink{namespaceLogin_1_1forms}{Login.forms} \textcolor{keyword}{import} LoginForm
00019 
00020 \textcolor{keyword}{import} \hyperlink{namespaceELO_1_1locale_1_1index}{ELO.locale.index} \textcolor{keyword}{as} lang
00021 
00022 \textcolor{comment}{## Interface para a camada de Apresentação de Usuário do módulo Login.}
00023 \textcolor{comment}{#   É responsável pelo carregamento do template correto e processa os dados}
00024 \textcolor{comment}{#   inseridos no formulário de login.}
\hypertarget{LoginUnit_8py_source_l00025}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin}{00025} \textcolor{keyword}{class }\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin}{IfUiLogin}:
00026     \textcolor{comment}{## Força a criação da camada subjacente}
00027     \_\_metaclass\_\_ = ABCMeta
00028 
\hypertarget{LoginUnit_8py_source_l00029}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_a2afcef7056181566ac0e801ad8094ece}{00029}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_a2afcef7056181566ac0e801ad8094ece}{\_\_init\_\_}(self, bus):
00030         \textcolor{keywordflow}{try}:
\hypertarget{LoginUnit_8py_source_l00031}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_af6823ae4c77d340c2341932d8f338753}{00031}             self.\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_af6823ae4c77d340c2341932d8f338753}{bus} = bus
00032         \textcolor{keywordflow}{except} TypeError \textcolor{keyword}{as} exc:
00033             del self
00034             \textcolor{keywordflow}{raise} exc
00035 
00036     \textcolor{comment}{## Objeto que representa a camada de negócio, subjacente a de UI.}
00037     \textcolor{comment}{#   Deve ser inicializada no momento da criação de um objeto do tipo}
00038     \textcolor{comment}{#   UiLogin, ou seja, uma camada de UI nunca existirá sem uma camada}
00039     \textcolor{comment}{#   de Bus suportando-a.}
00040     @property
\hypertarget{LoginUnit_8py_source_l00041}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_abab63bd2085f485ca82494db8eb5f520}{00041}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_af6823ae4c77d340c2341932d8f338753}{bus}(self):
00042         \textcolor{keywordflow}{return} self.\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_a550be8bfdf4cbc495bc966484e867af2}{\_\_bus}
00043 
00044     @bus.setter
\hypertarget{LoginUnit_8py_source_l00045}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_abab63bd2085f485ca82494db8eb5f520}{00045}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_af6823ae4c77d340c2341932d8f338753}{bus}(self, value):
00046         \textcolor{keywordflow}{if} isinstance(value, IfBusLogin):
00047             self.\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_a550be8bfdf4cbc495bc966484e867af2}{\_\_bus} = value
00048         \textcolor{keywordflow}{else}:
00049             \textcolor{keywordflow}{raise} TypeError(\textcolor{stringliteral}{"Expected IfBusLogin instance at \(\backslash\)}
00050 \textcolor{stringliteral}{                    UiLogin.\_\_bus. Received "} + str(type(value)) + \textcolor{stringliteral}{" instead."})
00051 
00052     \textcolor{comment}{## Método de deleção do objeto que representa a camada de negócio.}
00053     @bus.deleter
\hypertarget{LoginUnit_8py_source_l00054}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_abab63bd2085f485ca82494db8eb5f520}{00054}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_af6823ae4c77d340c2341932d8f338753}{bus}(self):
00055         del self.\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_a550be8bfdf4cbc495bc966484e867af2}{\_\_bus}
00056 
00057     \textcolor{comment}{## O método principal de qualquer classe de UI (user interface), o método}
00058     \textcolor{comment}{#   run() permite à Factory dar o controle do programa ao módulo de Login.}
00059     @abstractmethod
\hypertarget{LoginUnit_8py_source_l00060}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_ac6250c19afa63158907c6e8b4ff6dbd5}{00060}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin_ac6250c19afa63158907c6e8b4ff6dbd5}{run}(self, request): \textcolor{keyword}{pass}
00061 
00062 
00063 \textcolor{comment}{## Interface para a camada de negócio do módulo de Login.}
00064 \textcolor{comment}{#   Responsável pela validação dos dados submetidos através do formulário de}
00065 \textcolor{comment}{#   login.}
\hypertarget{LoginUnit_8py_source_l00066}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin}{00066} \textcolor{keyword}{class }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin}{IfBusLogin}: 
00067     \_\_metaclas\_\_ = ABCMeta
00068 
00069     \textcolor{comment}{## Método de validação.}
00070     \textcolor{comment}{#   Não deve retornar nada, mas lança uma exceção do tipo ValueError no}
00071     \textcolor{comment}{#   caso de uma validação mal-sucedida.}
00072     \textcolor{comment}{#}
00073     \textcolor{comment}{#   @arg username   Nome do usuário a ser validado.}
00074     \textcolor{comment}{#}
00075     \textcolor{comment}{#   @arg password   Senha a ser validada, junto ao username.}
00076     \textcolor{comment}{#}
00077     \textcolor{comment}{#   @arg database   Classe do modelo a ser utilizado.}
00078     @abstractmethod
\hypertarget{LoginUnit_8py_source_l00079}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a55078e3d16b3e0557b557aed92fd7c36}{00079}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a55078e3d16b3e0557b557aed92fd7c36}{validate}(self, username, password, database): \textcolor{keyword}{pass}
00080 
00081 
00082     \textcolor{comment}{## Método de recuperação de linguagem de sistema.}
00083     \textcolor{comment}{#   Retorna uma string com o código da linguagem preferida pelo usuário.}
00084     \textcolor{comment}{#}
00085     \textcolor{comment}{#   @arg username   Nome do usuário a ser verificado.}
00086     \textcolor{comment}{#}
00087     \textcolor{comment}{#   @arg database   Classe do modelo a ser utilizado.}
00088     @abstractmethod
\hypertarget{LoginUnit_8py_source_l00089}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a66e981f9d6fc6251de59568c1de028aa}{00089}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a66e981f9d6fc6251de59568c1de028aa}{getLang}(self, username, database): \textcolor{keyword}{pass}
00090 
00091     @property
\hypertarget{LoginUnit_8py_source_l00092}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a807b0a5d5bdae58087feb9d810a6538d}{00092}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a53b8075436052b94282021c84a2c3211}{pers}(self):
00093         \textcolor{keywordflow}{return} self.\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_aac72212096e8ac4cbad65a63d1d93221}{\_\_pers}
00094 
00095     @pers.setter
\hypertarget{LoginUnit_8py_source_l00096}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a807b0a5d5bdae58087feb9d810a6538d}{00096}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a53b8075436052b94282021c84a2c3211}{pers}(self, pers):
00097         \textcolor{keywordflow}{if} isinstance(value, IfPersLogin):
00098             self.\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_aac72212096e8ac4cbad65a63d1d93221}{\_\_pers} = pers
00099         \textcolor{keywordflow}{else}:
00100             \textcolor{keywordflow}{raise} TypeError(\textcolor{stringliteral}{"Expected IfPersLogin instance at \(\backslash\)}
00101 \textcolor{stringliteral}{                BusLogin.\_\_pers. Received "} + str(type(value)) + \textcolor{stringliteral}{"instead."})
00102 
00103     \textcolor{comment}{## Método de deleção do objeto que representa a camada de persistência.}
00104     @pers.deleter
\hypertarget{LoginUnit_8py_source_l00105}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a807b0a5d5bdae58087feb9d810a6538d}{00105}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a53b8075436052b94282021c84a2c3211}{pers}(self):
00106         del self.\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_aac72212096e8ac4cbad65a63d1d93221}{\_\_pers}
00107 
00108     \textcolor{comment}{## Força a criação da camada subjacente.}
\hypertarget{LoginUnit_8py_source_l00109}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a974c8e8520b02844836d9c7a8e06379b}{00109}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a974c8e8520b02844836d9c7a8e06379b}{\_\_init\_\_}(self, value):
00110         \textcolor{keywordflow}{try}:
\hypertarget{LoginUnit_8py_source_l00111}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a53b8075436052b94282021c84a2c3211}{00111}             self.\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin_a53b8075436052b94282021c84a2c3211}{pers} = value
00112         \textcolor{keywordflow}{except} TypeError \textcolor{keyword}{as} exc:
00113             del self
00114             \textcolor{keywordflow}{raise} exc
00115 
00116 
00117 \textcolor{comment}{## Interface para a camada de persistência do módulo de Login.}
00118 \textcolor{comment}{#   Deve ser capaz de capturar os dados necessários do banco de dados.}
\hypertarget{LoginUnit_8py_source_l00119}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfPersLogin}{00119} \textcolor{keyword}{class }\hyperlink{classLogin_1_1LoginUnit_1_1IfPersLogin}{IfPersLogin}:
00120 
00121     \_\_metaclass\_\_ = ABCMeta
00122 
00123     \textcolor{comment}{## Retorna um dicionário no formato de objeto com os dados do usuário}
00124     \textcolor{comment}{#   requisitado.}
00125     @abstractmethod
\hypertarget{LoginUnit_8py_source_l00126}{}\hyperlink{classLogin_1_1LoginUnit_1_1IfPersLogin_a24648e1c42d0762277b5b7aa641fa575}{00126}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1IfPersLogin_a24648e1c42d0762277b5b7aa641fa575}{select}(self, username, database): \textcolor{keyword}{pass}
00127 
00128 
00129 \textcolor{comment}{## Camada de interface de usuário para o módulo de Login.}
\hypertarget{LoginUnit_8py_source_l00130}{}\hyperlink{classLogin_1_1LoginUnit_1_1UiLogin}{00130} \textcolor{keyword}{class }\hyperlink{classLogin_1_1LoginUnit_1_1UiLogin}{UiLogin}(\hyperlink{classLogin_1_1LoginUnit_1_1IfUiLogin}{IfUiLogin}):
00131 
00132     \textcolor{comment}{## Método que inicia o módulo de login. }
00133     \textcolor{comment}{#   Aqui, ocorre a validação de formulário, autenticação de usuário, e}
00134     \textcolor{comment}{#   redirecionamento para a página de perfil.}
\hypertarget{LoginUnit_8py_source_l00135}{}\hyperlink{classLogin_1_1LoginUnit_1_1UiLogin_a9cd61a78d5ab0d201051ccf5898f86bc}{00135}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1UiLogin_a9cd61a78d5ab0d201051ccf5898f86bc}{run}(self, request, database):
00136         \textcolor{keywordflow}{if} request.method == \textcolor{stringliteral}{"POST"}:
00137             login\_form = \hyperlink{classLogin_1_1forms_1_1LoginForm}{LoginForm}(request.POST)
00138             \textcolor{keywordflow}{try}: 
00139                 \textcolor{keywordflow}{if} login\_form.is\_valid():
00140                     self.bus.validate(login\_form.cleaned\_data[\textcolor{stringliteral}{'username'}],
00141                         login\_form.cleaned\_data[\textcolor{stringliteral}{'password'}], database)
00142                 \textcolor{keywordflow}{else}:
00143                     \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_INV\_LOG'}])
00144             \textcolor{keywordflow}{except} ValueError \textcolor{keyword}{as} exc:
00145                 \textcolor{keywordflow}{if} database.\_\_name\_\_ == \textcolor{stringliteral}{"Professor"}:
00146                     target = \textcolor{stringliteral}{"proflogin"}
00147                 \textcolor{keywordflow}{elif} database.\_\_name\_\_ == \textcolor{stringliteral}{"Adm"}:
00148                     target = \textcolor{stringliteral}{"364fd8cdc3a35a89b7be75bc9d10ebea"}
00149                 \textcolor{keywordflow}{else}:
00150                     target = \textcolor{stringliteral}{""}
00151 
00152                 \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Login/form.html"}, \{\textcolor{stringliteral}{'form'}: login\_form, 
00153                     \textcolor{stringliteral}{'error'}: exc, \textcolor{stringliteral}{'target'}: target\})
00154             \textcolor{keywordflow}{else}:
00155                 cd = login\_form.cleaned\_data
00156                 l = self.bus.getLang(cd[\textcolor{stringliteral}{'username'}], database)
00157                 request.session[\textcolor{stringliteral}{'user'}] = \{
00158                                 \textcolor{stringliteral}{'name'}: cd[\textcolor{stringliteral}{'username'}].value,
00159                                 \textcolor{stringliteral}{'password'}: cd[\textcolor{stringliteral}{'password'}].value,
00160                                 \textcolor{stringliteral}{'language'}: l ,
00161                                 \textcolor{stringliteral}{'type'}: database.\_\_name\_\_,
00162                             \}
00163                 \textcolor{keywordflow}{return} HttpResponseRedirect(\textcolor{stringliteral}{'/'})
00164         \textcolor{keywordflow}{else}:
00165             login\_form = \hyperlink{classLogin_1_1forms_1_1LoginForm}{LoginForm}()
00166 
00167             \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} database:
00168                 target = \textcolor{stringliteral}{""}
00169             \textcolor{keywordflow}{if} database.\_\_name\_\_ == \textcolor{stringliteral}{"Professor"}:
00170                 target = \textcolor{stringliteral}{"proflogin"}
00171             \textcolor{keywordflow}{elif} database.\_\_name\_\_ == \textcolor{stringliteral}{"Adm"}:
00172                 target = \textcolor{stringliteral}{"364fd8cdc3a35a89b7be75bc9d10ebea"}
00173             \textcolor{keywordflow}{else}:
00174                 target = \textcolor{stringliteral}{""}
00175 
00176             \textcolor{keywordflow}{return} render(request, \textcolor{stringliteral}{"Login/form.html"}, \{\textcolor{stringliteral}{'form'}: login\_form, \textcolor{stringliteral}{'target'}: target\})
00177 
00178 
00179 \textcolor{comment}{## Camada de negócio de usuário para o módulo de Login.}
\hypertarget{LoginUnit_8py_source_l00180}{}\hyperlink{classLogin_1_1LoginUnit_1_1BusLogin}{00180} \textcolor{keyword}{class }\hyperlink{classLogin_1_1LoginUnit_1_1BusLogin}{BusLogin}(\hyperlink{classLogin_1_1LoginUnit_1_1IfBusLogin}{IfBusLogin}):
00181 
\hypertarget{LoginUnit_8py_source_l00182}{}\hyperlink{classLogin_1_1LoginUnit_1_1BusLogin_a2301425767b811697ce559801b955a58}{00182}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1BusLogin_a2301425767b811697ce559801b955a58}{validate}(self, username, password, database):
00183         upass = self.pers.select(username.value, database)
00184         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} upass \textcolor{keywordflow}{or} upass[\textcolor{stringliteral}{'password'}] != password.value:
00185             \textcolor{keywordflow}{raise} ValueError(lang.DICT[\textcolor{stringliteral}{'EXCEPTION\_INV\_LOG'}])
00186 
\hypertarget{LoginUnit_8py_source_l00187}{}\hyperlink{classLogin_1_1LoginUnit_1_1BusLogin_a23223ddd567bf874e6230efaf4912e98}{00187}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1BusLogin_a23223ddd567bf874e6230efaf4912e98}{getLang}(self, username, database):
00188         ulang = self.pers.select(username.value, database)
00189         \textcolor{keywordflow}{return} ulang[\textcolor{stringliteral}{'language'}]
00190 
00191 \textcolor{comment}{## Camada de persistência de usuário para o módulo de Login.}
\hypertarget{LoginUnit_8py_source_l00192}{}\hyperlink{classLogin_1_1LoginUnit_1_1PersLogin}{00192} \textcolor{keyword}{class }\hyperlink{classLogin_1_1LoginUnit_1_1PersLogin}{PersLogin}(\hyperlink{classLogin_1_1LoginUnit_1_1IfPersLogin}{IfPersLogin}):
00193 
\hypertarget{LoginUnit_8py_source_l00194}{}\hyperlink{classLogin_1_1LoginUnit_1_1PersLogin_a1847dbd744377283add2327d2eb0b99f}{00194}     \textcolor{keyword}{def }\hyperlink{classLogin_1_1LoginUnit_1_1PersLogin_a1847dbd744377283add2327d2eb0b99f}{select}(self, username=None, database=None):
00195         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} username: \textcolor{keywordflow}{return} \textcolor{keyword}{False}
00196         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} database: \textcolor{keywordflow}{return} \textcolor{keyword}{False}
00197 
00198         \textcolor{keywordflow}{try}:
00199             uid = database.objects.get(value=username, field=\textcolor{stringliteral}{'NAME'}).identity
00200             upass = database.objects.get(identity=uid, field=\textcolor{stringliteral}{'PASSWORD'}).value
00201         \textcolor{keywordflow}{except} database.DoesNotExist:
00202             \textcolor{keywordflow}{return} \textcolor{keyword}{False}
00203 
00204         \textcolor{keywordflow}{try}:
00205             ulang = database.objects.get(identity=uid, field=\textcolor{stringliteral}{'LANGUAGE'}).value
00206         \textcolor{keywordflow}{except} database.DoesNotExist:
00207             \textcolor{keywordflow}{pass}
00208 
00209         \textcolor{keywordflow}{return} \{\textcolor{stringliteral}{'name'}: username, \textcolor{stringliteral}{'password'}: upass, \textcolor{stringliteral}{'language'}: ulang\}
\end{DoxyCode}
